<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>연차관리 시스템</title>
  
  <!-- 🎨 CSS 스타일 -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f6fa;
      line-height: 1.6;
    }
    
    /* 🔝 헤더 */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .notification-icon {
      position: relative;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .notification-icon:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.7rem;
      font-weight: bold;
      display: none;
    }
    
    .user-menu {
      position: relative;
    }
    
    .user-button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .user-button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 0.5rem 0;
      min-width: 200px;
      display: none;
      z-index: 1001;
      color: #333;
    }
    
    .user-dropdown a {
      display: block;
      padding: 0.75rem 1rem;
      color: #333;
      text-decoration: none;
      transition: background 0.2s ease;
      cursor: pointer;
    }
    
    .user-dropdown a:hover {
      background: #f8f9fa;
    }
    
    /* 📱 사이드바 */
    .sidebar {
      width: 250px;
      background: white;
      height: calc(100vh - 70px);
      position: fixed;
      left: 0;
      top: 70px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    
    .sidebar.hidden {
      transform: translateX(-100%);
    }
    
    .menu-item {
      display: block;
      padding: 1rem 1.5rem;
      color: #333;
      text-decoration: none;
      border-bottom: 1px solid #eee;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .menu-item:hover {
      background: #f8f9fa;
      padding-left: 2rem;
    }
    
    .menu-item.active {
      background: #667eea;
      color: white;
      border-left: 4px solid #5a67d8;
    }
    
    .menu-item .icon {
      margin-right: 0.5rem;
    }
    
    /* 📄 메인 콘텐츠 */
    .main-content {
      margin-left: 250px;
      padding: 2rem;
      min-height: calc(100vh - 70px);
      transition: margin-left 0.3s ease;
    }
    
    .main-content.full-width {
      margin-left: 0;
    }
    
    .page {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }
    
    .page.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .page-header {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    
    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
      color: #666;
    }
    
    /* 🏠 대시보드 헤더 양쪽 정렬 스타일 */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
    }
    
    .dashboard-title-section {
      flex: 1;
    }
    
    .dashboard-dept-section {
      flex-shrink: 0;
    }
    
    .dept-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .dept-badge:before {
      content: "🏢";
      font-size: 1.1rem;
    }
    
    .dept-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* 부서 배지 로딩 상태 */
    .dept-badge.loading-badge {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      animation: pulse-loading 1.5s ease-in-out infinite;
    }
    
    .dept-badge.loading-badge:before {
      content: "⏳";
    }
    
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
         @keyframes pulse-loading {
       0%, 100% { 
         opacity: 0.7;
         transform: scale(1);
       }
       50% { 
         opacity: 1;
         transform: scale(1.02);
       }
     }
     
     @keyframes dots {
       0%, 20% { 
         color: rgba(255,255,255,0.4);
         text-shadow: 
           .25em 0 0 rgba(255,255,255,0.4),
           .5em 0 0 rgba(255,255,255,0.4);
       }
       40% { 
         color: white;
         text-shadow: 
           .25em 0 0 rgba(255,255,255,0.4),
           .5em 0 0 rgba(255,255,255,0.4);
       }
       60% { 
         text-shadow: 
           .25em 0 0 white,
           .5em 0 0 rgba(255,255,255,0.4);
       }
       80%, 100% { 
         text-shadow: 
           .25em 0 0 white,
           .5em 0 0 white;
       }
     }
     
     @keyframes shimmer {
       0% {
         background-position: -200% 0;
       }
       100% {
         background-position: 200% 0;
       }
     }
    
    /* 📅 근무표 스타일 */
    .schedule-controls {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    
    .work-schedule-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .work-schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      table-layout: fixed;
    }
    
    .work-schedule-table th,
    .work-schedule-table td {
      border: 1px solid #e0e0e0;
      padding: 0.4rem;
      text-align: center;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .work-schedule-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* 제목 행 */
    .schedule-title {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      padding: 1rem;
    }
    
    /* 헤더 행 */
    .schedule-header {
      background: #e3f2fd;
      font-weight: 600;
      color: #1976d2;
    }
    
    /* 직원 정보 열 */
    .employee-info {
      background: #f8f9fa;
      font-weight: 500;
      text-align: left;
      padding-left: 0.8rem;
    }
    
    /* 주말 색상 */
    .weekend-saturday {
      background-color: #e3f2fd !important;
      color: #1976d2;
    }
    
    .weekend-sunday,
    .holiday {
      background-color: #ffebee !important;
      color: #d32f2f;
    }
    
    /* 연차 표시 */
    .leave-full {
      background-color: #c8e6c9 !important;
      color: #2e7d32;
      font-weight: bold;
    }
    
    .leave-half {
      background-color: #fff3e0 !important;
      color: #f57c00;
      font-weight: bold;
    }
    
    /* 근무일 */
    .work-day {
      background-color: #fafafa;
    }
    
    /* 사용자 부서 정보 */
    .user-dept-info {
      margin-bottom: 1.5rem;
    }
    
    .dept-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .dept-icon {
      font-size: 1.2rem;
    }
    
    .dept-name {
      font-size: 1rem;
    }

    /* 로딩 상태 스타일 */
    .loading-badge {
      opacity: 0.6;
      position: relative;
    }

    .loading-badge::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* 로딩 상태 */
    .schedule-loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    
    .schedule-loading .spinner {
      margin: 0 auto 1rem;
    }

    /* 빈 상태 스타일 */
    .empty-state, .error-state, .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-icon, .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state h3, .error-state h3 {
      margin: 16px 0 8px 0;
      color: #333;
    }

    .empty-state p, .error-state p {
      margin: 8px 0 24px 0;
      color: #666;
    }

    /* 로딩 스피너 */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 📊 대시보드 카드 */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    
    .card-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    
    .card-value {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }
    
    .card-label {
      color: #666;
      font-size: 0.9rem;
    }
    
    /* 📝 폼 스타일 */
    .form-container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* 로딩 상태 입력 필드 */
    .loading-input {
      background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s ease-in-out infinite !important;
      color: #6c757d !important;
      font-style: italic !important;
    }
    
    /* 🔘 버튼 */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
      background: #2ed573;
      color: white;
    }
    
    .btn-danger {
      background: #ff4757;
      color: white;
    }
    
    .btn-secondary {
      background: #747d8c;
      color: white;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* 📋 테이블 */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    
    .table tr:hover {
      background: #f8f9fa;
    }
    
    /* 🏷️ 상태 라벨 */
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    /* 📱 모바일 반응형 */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.visible {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        padding: 1rem;
      }
      
      .header-content {
        padding: 0 1rem;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      /* 직원 관리 모바일 최적화 */
      .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .search-controls {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .search-input {
        width: 100%;
      }
      
      .btn-reset {
        width: 100%;
        justify-content: center;
      }
      
      /* 모바일에서 테이블 스크롤 */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .employee-table {
        min-width: 650px;
      }
      
      .employee-table .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        min-width: 50px;
      }
      
      .employee-table .btn-text {
        display: none;
      }
      
      .employee-table .btn-icon {
        font-size: 1rem;
      }
      
      .info-banner {
        flex-direction: column;
        text-align: center;
      }
      
      .info-icon {
        align-self: center;
        margin-top: 0;
      }
      
      .btn-large {
        width: 100%;
        padding: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .search-input {
        font-size: 16px; /* iOS에서 줌 방지 */
      }
      
      .employee-table th,
      .employee-table td {
        padding: 0.75rem 0.5rem;
      }
      
      .col-email {
        min-width: 150px;
      }
    }
    
    /* 💬 메시지 */
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-color: #28a745;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-color: #dc3545;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #17a2b8;
    }
    
    /* 👥 직원 관리 페이지 전용 스타일 */
    .employee-form-section,
    .employee-list-section {
      margin-bottom: 2.5rem;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #333;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* 정보 배너 스타일 */
    .info-banner {
      background: linear-gradient(135deg, #e8f4fd 0%, #f1f8ff 100%);
      border: 1px solid #bee5eb;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .info-icon {
      font-size: 1.5rem;
      margin-top: 0.2rem;
    }
    
    .info-content {
      flex: 1;
      color: #0c5460;
    }
    
    .info-content strong {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    
    .info-list {
      margin: 0;
      padding-left: 1.2rem;
      list-style: none;
    }
    
    .info-list li {
      position: relative;
      margin-bottom: 0.3rem;
      padding-left: 0.5rem;
    }
    
    .info-list li::before {
      content: '•';
      position: absolute;
      left: -0.8rem;
      color: #667eea;
      font-weight: bold;
    }
    
    .info-list code {
      background: rgba(255, 255, 255, 0.8);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #e74c3c;
    }
    
    /* 폼 액션 버튼 영역 */
    .form-actions {
      text-align: center;
      margin-top: 2.5rem;
      padding-top: 2rem;
      border-top: 1px solid #e9ecef;
    }
    
    .btn-large {
      padding: 1rem 2.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.7rem;
      min-width: 180px;
      justify-content: center;
    }
    
    .btn-icon {
      font-size: 1.2rem;
    }
    
    .btn-text {
      font-weight: 600;
    }
    
    /* 검색 컨트롤 */
    .search-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .search-input-wrapper {
      position: relative;
    }
    
    .search-input {
      padding: 0.75rem 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      width: 280px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
      background-color: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-reset {
      padding: 0.75rem 1.2rem;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 100px;
      justify-content: center;
    }
    
    /* 직원 테이블 개선 */
    .employee-table {
      margin: 0;
    }
    
    .employee-table th {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #495057;
      font-weight: 700;
      text-align: center;
      vertical-align: middle;
      padding: 1rem 0.75rem;
      border-bottom: 2px solid #dee2e6;
      white-space: nowrap;
    }
    
    .employee-table td {
      text-align: center;
      vertical-align: middle;
      padding: 1rem 0.75rem;
      border-bottom: 1px solid #e9ecef;
    }
    
    .employee-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .employee-table tbody tr:hover {
      background-color: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    /* 테이블 컬럼 너비 조정 */
    .col-empid {
      width: 10%;
      min-width: 80px;
    }
    
    .col-name {
      width: 15%;
      min-width: 100px;
    }
    
    .col-email {
      width: 25%;
      min-width: 200px;
      text-align: left !important;
      padding-left: 1rem !important;
    }
    
    .col-dept {
      width: 15%;
      min-width: 100px;
    }
    
    .col-position {
      width: 15%;
      min-width: 100px;
    }
    
    .col-actions {
      width: 20%;
      min-width: 160px;
    }
    
    /* 테이블 액션 버튼 */
    .employee-table .btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      font-weight: 600;
      margin: 0 0.2rem;
      min-width: 60px;
    }
    
    /* 로딩 셀 */
    .loading-cell {
      text-align: center !important;
      color: #6c757d;
      font-style: italic;
      padding: 2rem !important;
      background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    /* 빈 메시지 셀 */
    .empty-message {
      text-align: center !important;
      color: #6c757d;
      font-style: italic;
      padding: 2.5rem !important;
      background: #f8f9fa;
      font-size: 1.1rem;
    }
    
    .search-empty-message {
      text-align: center !important;
      color: #856404;
      font-style: italic;
      padding: 2.5rem !important;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      font-size: 1.1rem;
    }
    
    /* 🔄 로딩 */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: ''; }
    }
    
    /* 알림 애니메이션 */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    /* 로딩 스피너 */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin-bottom: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 선택된 직원 스타일 */
    .selected-employee {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
    }

    .selected-employee .employee-name {
      font-weight: 600;
      color: #333;
    }

    .selected-employee .employee-dept {
      color: #666;
      font-size: 0.9rem;
    }

    .btn-remove {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-remove:hover {
      background: #c82333;
    }
    
    /* 🔧 직원 수정 모달 스타일 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }
    
    .close-button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      color: #6c757d;
    }
    
    .close-button:hover {
      color: #343a40;
    }
    
    .modal-body {
      padding: 1rem;
      overflow-y: auto;
    }
    
    .search-box {
      margin-bottom: 1rem;
    }
    
    .search-box input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1rem;
    }
    
    .employee-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .employee-item {
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .employee-item:hover {
      background-color: #f8f9fa;
      border-color: #dee2e6;
    }
    
    .employee-item.selected {
      background-color: #e7f5ff;
      border-color: #339af0;
    }
    
    .employee-info {
      flex: 1;
    }
    
    .employee-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .employee-position {
      color: #6c757d;
      font-size: 0.875rem;
    }
    
    .employee-dept {
      color: #495057;
      font-size: 0.875rem;
      padding-left: 1rem;
      border-left: 1px solid #dee2e6;
    }
    
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    
    .btn-modal {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .btn-modal-primary {
      background-color: #339af0;
      color: white;
    }
    
    .btn-modal-primary:hover {
      background-color: #228be6;
    }
    
    .btn-modal-secondary {
      background-color: #e9ecef;
      color: #495057;
    }
    
    .btn-modal-secondary:hover {
      background-color: #dee2e6;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 📄 페이지네이션 스타일 */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .pagination-info {
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .pagination-btn {
      padding: 0.5rem 0.75rem;
      border: 1px solid #dee2e6;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      font-weight: 500;
      min-width: 40px;
      text-align: center;
      text-decoration: none;
    }
    
    .pagination-btn:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    .pagination-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    .pagination-btn:disabled {
      background: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .pagination-btn:disabled:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
    }
    
    .pagination-select {
      padding: 0.4rem 0.6rem;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }
    
    .pagination-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    /* 페이지네이션 설정 */
    .pagination-settings {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    /* 모바일 반응형 */
    @media (max-width: 768px) {
      .modal-container {
        width: 95%;
        max-height: 95vh;
        margin: 1rem;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .modal-footer {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .btn-modal {
        width: 100%;
        justify-content: center;
      }
      
      /* 페이지네이션 모바일 최적화 */
      .pagination-container {
        flex-direction: column;
        gap: 1rem;
        padding: 0.75rem;
      }
      
      .pagination-info {
        order: 2;
        text-align: center;
      }
      
      .pagination-controls {
        order: 1;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .pagination-settings {
        order: 3;
        justify-content: center;
      }
      
      .pagination-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        min-width: 35px;
      }
    }
    
    /* 🎯 드래그 앤 드롭 보드 스타일 */
    
    /* 뷰 전환 탭 스타일 */
    .view-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .view-tabs {
      display: flex;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.25rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .view-tab {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      color: #6c757d;
    }
    
    .view-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .view-tab:hover:not(.active) {
      background: #e9ecef;
      color: #495057;
    }
    
    .tab-icon {
      font-size: 1.1rem;
    }
    
    .tab-text {
      font-weight: 600;
    }
    
    /* 직원 뷰 전환 */
    .employee-view {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
    }
    
    .employee-view.active {
      display: block;
    }
    
    /* 부서 뷰 전환 */
    .department-view {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
    }
    
    .department-view.active {
      display: block;
    }
    
    /* 보드 컨테이너 스타일 */
    .board-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .board-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .board-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    .board-subtitle {
      color: rgba(255,255,255,0.9);
      margin: 0.5rem 0 0 0;
      font-size: 0.95rem;
    }
    
    .board-stats {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    
    .board-stat {
      background: rgba(255,255,255,0.2);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }
    
    .board-stat strong {
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    /* 🎨 컴팩트한 부서 추가 폼 스타일 */
    .compact-form-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .compact-form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }
    
    .compact-form-header {
      text-align: center;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 1;
    }
    
    .compact-form-title {
      color: #ffffff;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .compact-form {
      position: relative;
      z-index: 1;
    }
    
    .compact-form-row {
      display: flex;
      gap: 1rem;
      align-items: end;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .compact-form-group {
      display: flex;
      flex-direction: column;
      min-width: 200px;
    }
    
    .compact-form-group label {
      color: #ffffff;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .compact-form-group input {
      padding: 0.75rem 1rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.95);
      font-size: 0.95rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .compact-form-group input:focus {
      outline: none;
      border-color: #ffffff;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .compact-form-group input::placeholder {
      color: #6c757d;
      opacity: 0.7;
    }
    
    .btn-compact {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      text-transform: none;
      letter-spacing: -0.025em;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-compact-primary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-compact-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
      background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
    }
    
    .btn-compact-primary:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    /* 🏢 메인 부서 관리 섹션 */
    .department-management-main {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      min-height: 600px;
    }
    
    .main-section-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #dee2e6;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .section-title-area {
      flex: 1;
      min-width: 250px;
    }
    
    .main-section-title {
      color: #2c3e50;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      letter-spacing: -0.025em;
    }
    
    .main-section-subtitle {
      color: #6c757d;
      font-size: 0.95rem;
      margin: 0;
      line-height: 1.5;
    }
    
    .view-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .view-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .view-tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      color: #6c757d;
    }
    
    .view-tab:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      transform: translateY(-1px);
    }
    
    .view-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .tab-icon {
      font-size: 1rem;
    }
    
    .tab-text {
      font-weight: 600;
    }
    
    /* 부서 뷰 컨테이너 */
    .department-view {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .department-view.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 🎯 개선된 Kanban 보드 스타일 (그리드 레이아웃) */
    .kanban-board {
      padding: 1.5rem;
      display: grid;
      gap: 1.5rem;
      min-height: 500px;
      background: #f8f9fa;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      max-width: 100%;
    }
    
    /* 부서 수에 따른 그리드 레이아웃 최적화 */
    .kanban-board.departments-1 { grid-template-columns: 1fr; }
    .kanban-board.departments-2 { grid-template-columns: repeat(2, 1fr); }
    .kanban-board.departments-3 { grid-template-columns: repeat(3, 1fr); }
    .kanban-board.departments-4 { grid-template-columns: repeat(2, 1fr); }
    .kanban-board.departments-5 { grid-template-columns: repeat(3, 1fr); }
    .kanban-board.departments-6 { grid-template-columns: repeat(3, 1fr); }
    .kanban-board.departments-7 { grid-template-columns: repeat(4, 1fr); }
    .kanban-board.departments-8 { grid-template-columns: repeat(4, 1fr); }
    .kanban-board.departments-many { grid-template-columns: repeat(4, 1fr); }
    
    .board-loading {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      color: #6c757d;
      font-style: italic;
    }
    
    .board-loading .spinner {
      margin-bottom: 1rem;
    }
    
    /* 부서 칼럼 스타일 */
    .department-column {
      flex: none;
      width: 100%;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      max-height: 400px;
      min-height: 300px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .department-column.drag-over {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }
    
    .department-column.drop-available {
      border-color: rgba(102, 126, 234, 0.3);
      background: rgba(102, 126, 234, 0.02);
    }
    
    .department-column.drop-available:not(.drag-over) {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { 
        border-color: rgba(102, 126, 234, 0.2);
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      }
      50% { 
        border-color: rgba(102, 126, 234, 0.4);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
      }
      100% { 
        border-color: rgba(102, 126, 234, 0.2);
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      }
    }
    
    .column-header {
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 2px solid #dee2e6;
      text-align: center;
      border-radius: 10px 10px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .column-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #495057;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .column-count {
      background: #667eea;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    
    .column-body {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .column-empty {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 2rem 1rem;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      background: #f8f9fa;
    }
    
    /* 직원 카드 스타일 */
    .employee-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: move;
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
      position: relative;
    }
    
    .employee-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    
    .employee-card.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .card-name {
      font-weight: 700;
      color: #333;
      font-size: 1rem;
    }
    
    .card-empid {
      background: #e9ecef;
      color: #6c757d;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .card-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .card-email {
      color: #667eea;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .card-position {
      color: #6c757d;
      font-size: 0.85rem;
    }
    
    .card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e9ecef;
    }
    
    .card-btn {
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
    }
    
    .card-btn-edit {
      background: #28a745;
      color: white;
    }
    
    .card-btn-edit:hover {
      background: #218838;
    }
    
    .card-btn-delete {
      background: #dc3545;
      color: white;
    }
    
    .card-btn-delete:hover {
      background: #c82333;
    }
    
    /* 드래그 앤 드롭 시각적 피드백 */
    .drop-indicator {
      height: 2px;
      background: #667eea;
      margin: 0.5rem 0;
      border-radius: 1px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .drop-indicator.active {
      opacity: 1;
    }
    
    .card-placeholder {
      background: rgba(102, 126, 234, 0.1);
      border: 2px dashed #667eea;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      color: #667eea;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    /* 🎨 개선된 테이블 스타일 (부서 목록 뷰) */
    .department-view .table-container {
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      padding: 1.5rem;
    }
    
    .department-view .table {
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      border: 1px solid #e9ecef;
    }
    
    .department-view .table thead {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-bottom: 2px solid #dee2e6;
    }
    
    .department-view .table thead th {
      color: #2c3e50;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      padding: 1.25rem 1rem;
      border: none;
      text-shadow: none;
      text-align: center;
    }
    
    .department-view .table thead th:nth-child(2) {
      text-align: left;
    }
    
    .department-view .table tbody td {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid #f1f3f4;
      vertical-align: middle;
      font-size: 0.95rem;
      text-align: center;
    }
    
    .department-view .table tbody td:first-child {
      text-align: center;
      font-weight: 600;
    }
    
    .department-view .table tbody td:nth-child(2) {
      text-align: left;
      font-weight: 500;
    }
    
    .department-view .table tbody td:nth-child(3) {
      text-align: center;
    }
    
    .department-view .table tbody td:last-child {
      text-align: center;
    }
    
    .department-view .table tbody tr {
      transition: all 0.3s ease;
    }
    
    .department-view .table tbody tr:hover {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      transform: translateX(4px);
    }
    
    .department-view .table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .department-view .table .empty-message {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 3rem 2rem;
      background: #f8f9fa;
    }
    
    /* 🎨 개선된 버튼 스타일 (테이블 내) */
    .department-view .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }
    
    .department-view .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .department-view .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: #ffffff;
    }
    
    .department-view .btn-secondary:hover {
      background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
    }
    
    .department-view .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: #ffffff;
    }
    
    .department-view .btn-danger:hover {
      background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    }
    
    /* 📱 반응형 디자인 개선 */
    @media (max-width: 768px) {
      .compact-form-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .compact-form-group {
        min-width: 100%;
        width: 100%;
      }
      
      .main-section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.5rem;
      }
      
      .section-title-area {
        min-width: 100%;
      }
      
      .view-controls {
        width: 100%;
        justify-content: center;
        flex-direction: column;
        align-items: stretch;
      }
      
      .view-tabs {
        width: 100%;
      }
      
      .view-tab {
        flex: 1;
        justify-content: center;
      }
      
      .department-view .table-container {
        padding: 1rem;
      }
      
      .department-view .table {
        font-size: 0.9rem;
      }
      
      .department-view .table thead th {
        padding: 1rem 0.75rem;
        font-size: 0.8rem;
      }
      
      .department-view .table tbody td {
        padding: 1rem 0.75rem;
      }
      
      .board-header {
        flex-direction: column;
        text-align: center;
      }
      
      .board-stats {
        justify-content: center;
      }
      
      .kanban-board {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 1rem;
        padding: 1rem;
      }
      
      .department-column {
        flex: none;
        max-height: none;
      }
      
      .column-body {
        max-height: 300px;
      }
    }
    
    @media (max-width: 480px) {
      .compact-form-section {
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .compact-form-title {
        font-size: 1.1rem;
      }
      
      .main-section-header {
        padding: 1.5rem;
      }
      
      .main-section-title {
        font-size: 1.25rem;
      }
      
      .department-view .table-container {
        padding: 0.75rem;
      }
      
      .department-view .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      
      .kanban-board {
        padding: 0.75rem;
      }
      
      .department-column {
        flex: 0 0 240px;
      }
    }
    
    /* 📈 통계 페이지 전용 스타일 */
    .stats-section {
      background: #ffffff;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      border: 1px solid #e9ecef;
    }
    
    .stats-section-title {
      color: #2c3e50;
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0 0 1.5rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e9ecef;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* 데이터 관리 그리드 */
    .data-management-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .data-action-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      border: 1px solid #dee2e6;
      transition: all 0.3s ease;
    }
    
    .data-action-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    
    .action-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    
    .action-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
    
    .action-desc {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      line-height: 1.4;
    }
    
    /* 통계 대시보드 카드 개선 */
    #statisticsPage .dashboard-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    #statisticsPage .dashboard-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
    }
    
    /* 새로운 버튼 스타일 */
    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: #ffffff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
    }
    
    /* 상태 색상 */
    .status-excellent { color: #28a745; font-weight: 600; }
    .status-good { color: #20c997; font-weight: 600; }
    .status-warning { color: #ffc107; font-weight: 600; }
    .status-danger { color: #dc3545; font-weight: 600; }

    /* 관리자 정보 카드 스타일 */
    .dashboard-card.admin-info {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
      border: 1px solid #ff5722;
    }
    
    .dashboard-card.admin-info .card-icon {
      color: rgba(255, 255, 255, 0.9);
    }
    
    .dashboard-card.admin-info .card-value {
      color: white;
      font-weight: 700;
    }
    
    .dashboard-card.admin-info .card-label {
      color: rgba(255, 255, 255, 0.8);
    }
    
    .dashboard-card.admin-info:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(255, 107, 107, 0.4);
    }
    
    /* 오류 카드 스타일 */
    .dashboard-card.error {
      background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
      color: white;
      border: 1px solid #ff3742;
    }
    
    .dashboard-card.error .card-icon {
      color: rgba(255, 255, 255, 0.9);
    }
    
    .dashboard-card.error .card-value {
      color: white;
      font-weight: 700;
    }
    
    .dashboard-card.error .card-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.85rem;
    }

    /* 직원 선택 모달 스타일 */
    .employee-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    .employee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .employee-item:last-child {
      border-bottom: none;
    }

    .employee-item:hover {
      background-color: #f8f9fa;
    }

    .employee-item.selected {
      background-color: #e3f2fd;
      border-left: 4px solid #1976d2;
    }

    .employee-info {
      flex: 1;
    }

    .employee-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .employee-position {
      font-size: 0.85rem;
      color: #666;
    }

    .employee-dept {
      font-size: 0.85rem;
      color: #666;
      padding: 0.25rem 0.5rem;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
      outline: none;
    }
    
    /* 모바일 반응형 - 통계 페이지 */
    @media (max-width: 768px) {
      .stats-section {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }
      
      .stats-section-title {
        font-size: 1.1rem;
      }
      
      .data-management-grid {
        grid-template-columns: 1fr;
      }
      
      .data-action-card {
        padding: 1.25rem;
      }
    }
  </style>
</head>

<body>
  <!-- 🔝 헤더 -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        📋 연차관리 시스템
      </div>
      
      <div class="header-right">
        <!-- 📢 알림 아이콘 -->
        <button class="notification-icon" onclick="showNotifications()">
          🔔
          <span id="notificationBadge" class="notification-badge">0</span>
        </button>
        
        <!-- 👤 사용자 메뉴 -->
        <div class="user-menu">
          <button class="user-button" onclick="toggleUserMenu()">
            <? if (user.userType === 'admin') { ?>
              🔐 <?= user.name ?> (관리자)
            <? } else { ?>
              👤 <?= user.name ?>
            <? } ?>
            <span style="margin-left: 0.5rem;">▼</span>
          </button>
          
          <div id="userDropdown" class="user-dropdown">
            <a onclick="showPage('myInfo')">👤 내 정보</a>
            <a onclick="showPage('changePassword')">🔑 비밀번호 변경</a>
            <? if (user.isAdmin) { ?>
              <a onclick="showPage('adminMenu')">🔧 관리자 메뉴</a>
            <? } ?>
            <a onclick="logout()">🚪 로그아웃</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 📱 사이드바 -->
  <nav class="sidebar" id="sidebar">
    <a class="menu-item active" onclick="showPage('dashboard')">
      <span class="icon">🏠</span> 대시보드
    </a>
    <? if (user.userType === 'admin') { ?>
      <!-- 관리자 전용 메뉴 -->
      <a class="menu-item" onclick="showPage('employeeManagement')">
        <span class="icon">👥</span> 직원 관리
      </a>
      <a class="menu-item" onclick="showPage('departmentManagement')">
        <span class="icon">🏢</span> 부서 관리
      </a>
      <a class="menu-item" onclick="showPage('statistics')">
        <span class="icon">📈</span> 통계 및 보고서
      </a>
      <a class="menu-item" onclick="showPage('systemSettings')">
        <span class="icon">⚙️</span> 설정
      </a>
    <? } else { ?>
      <!-- 직원 전용 메뉴 -->
      <a class="menu-item" onclick="showPage('leaveRequest')">
        <span class="icon">📝</span> 연차 신청
      </a>
      <a class="menu-item" onclick="showPage('myRequests')">
        <span class="icon">📊</span> 내 신청 현황
      </a>
      <a class="menu-item" onclick="showPage('approvals')">
        <span class="icon">✅</span> 결재/협조 처리
      </a>
      <a class="menu-item" onclick="showPage('workSchedule')">
        <span class="icon">📅</span> 근무표
      </a>
      <? if (user.isAdmin) { ?>
        <a class="menu-item" onclick="showPage('adminMenu')">
          <span class="icon">🔧</span> 관리자 메뉴
        </a>
      <? } ?>
    <? } ?>
  </nav>

  <!-- 📄 메인 콘텐츠 -->
  <main class="main-content" id="mainContent">
    
    <!-- 🏠 대시보드 페이지 -->
    <div id="dashboardPage" class="page active">
      <div class="page-header dashboard-header">
        <div class="dashboard-title-section">
          <h1 class="page-title">🏠 대시보드</h1>
          <? if (user.userType === 'admin') { ?>
            <p class="page-subtitle" id="dashboardSubtitle">안녕하세요, <?= user.name ?> 관리자님! 시스템 관리 대시보드입니다.</p>
          <? } else { ?>
            <p class="page-subtitle" id="dashboardSubtitle">안녕하세요, <?= user.name ?>님! 연차 현황을 확인해보세요.</p>
          <? } ?>
        </div>
        <div class="dashboard-dept-section">
          <span class="dept-badge loading-badge" id="dashboardDeptBadge">
            <span class="loading-dots">로딩중</span>
          </span>
        </div>
      </div>
      
      <? if (user.userType === 'admin') { ?>
        <!-- 관리자용 시스템 현황 대시보드 -->
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-icon">👥</div>
            <div class="card-value" id="totalEmployees">-</div>
            <div class="card-label">전체 직원 수</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">📝</div>
            <div class="card-value" id="totalRequests">-</div>
            <div class="card-label">총 연차 신청</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">✅</div>
            <div class="card-value" id="approvedRequests">-</div>
            <div class="card-label">승인된 신청</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">🏢</div>
            <div class="card-value" id="totalDepartments">-</div>
            <div class="card-label">전체 부서 수</div>
          </div>
        </div>
      <? } else { ?>
        <!-- 직원용 개인 연차 대시보드 -->
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-icon">📅</div>
            <div class="card-value" id="remainingLeaves">-</div>
            <div class="card-label">남은 연차</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">📝</div>
            <div class="card-value" id="pendingRequests">-</div>
            <div class="card-label">대기 중인 신청</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">✅</div>
            <div class="card-value" id="pendingApprovals">-</div>
            <div class="card-label">결재 대기</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">📊</div>
            <div class="card-value" id="thisMonthUsed">-</div>
            <div class="card-label">이번 달 사용</div>
          </div>
        </div>
      <? } ?>
      
      <!-- 최근 활동 -->
      <? if (user.userType === 'admin') { ?>
        <!-- 관리자용 시스템 관리 바로가기 -->
        <div class="recent-activity">
          <h3 style="padding: 1rem; margin: 0; background: #f8f9fa; font-weight: 600;">🔧 관리 바로가기</h3>
          <div class="dashboard-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1.5rem; padding: 1.5rem;">
            <div class="dashboard-card" onclick="showPage('employeeManagement')" style="cursor: pointer;">
              <div class="card-icon">👥</div>
              <div class="card-value">직원 관리</div>
              <div class="card-label">직원 추가/수정/삭제</div>
            </div>
            
            <div class="dashboard-card" onclick="showPage('departmentManagement')" style="cursor: pointer;">
              <div class="card-icon">🏢</div>
              <div class="card-value">부서 관리</div>
              <div class="card-label">부서 추가/수정/삭제</div>
            </div>
          </div>
        </div>
      <? } else { ?>
        <!-- 직원용 최근 신청 내역 -->
        <div class="table-container">
          <h3 style="padding: 1rem; margin: 0; background: #f8f9fa; font-weight: 600;">최근 연차 신청 내역</h3>
          <table class="table">
            <thead>
              <tr>
                <th>신청일</th>
                <th>연차 종류</th>
                <th>기간</th>
                <th>상태</th>
                <th>사유</th>
              </tr>
            </thead>
            <tbody id="recentRequestsTable">
              <tr>
                <td colspan="5" class="loading">최근 내역을 불러오는 중입니다</td>
              </tr>
            </tbody>
          </table>
        </div>
      <? } ?>
    </div>

    <!-- 📝 연차 신청 페이지 -->
    <div id="leaveRequestPage" class="page">
      <div class="page-header">
        <h1 class="page-title">📝 연차 신청</h1>
        <p class="page-subtitle">연차를 신청하고 결재자/협조자를 선택하세요.</p>
      </div>
      
      <div class="form-container">
        <form id="leaveRequestForm" onsubmit="submitLeaveRequest(event)">
          <div class="form-grid">
            <div class="form-group">
              <label for="startDate">시작일 *</label>
              <input type="date" id="startDate" required onchange="calculateLeaveDays()">
            </div>
            
            <div class="form-group">
              <label for="endDate">종료일 *</label>
              <input type="date" id="endDate" required onchange="calculateLeaveDays()">
            </div>
            
            <div class="form-group">
              <label for="leaveType">연차 종류 *</label>
              <select id="leaveType" required onchange="calculateLeaveDays()">
                <option value="">선택하세요</option>
                <option value="연차">연차</option>
                <option value="반차">반차</option>
                <option value="특별휴가">특별휴가</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="calculatedDays">계산된 일수</label>
              <input type="text" id="calculatedDays" readonly placeholder="자동 계산됩니다">
            </div>
          </div>
          
          <div class="form-group">
            <label for="reason">신청 사유 *</label>
            <textarea id="reason" required placeholder="연차 신청 사유를 입력하세요"></textarea>
          </div>
          
          <!-- 결재자 선택 -->
          <div class="form-group">
            <label>결재자 선택 *</label>
            <button type="button" class="btn btn-secondary" onclick="openApproverModal()">
              🔍 결재자 추가
            </button>
            <div id="selectedApprovers" style="margin-top: 1rem;">
              <!-- 선택된 결재자들이 여기에 표시됩니다 -->
            </div>
          </div>
          
          <!-- 협조자 선택 -->
          <div class="form-group">
            <label>협조자 선택 (선택사항)</label>
            <button type="button" class="btn btn-secondary" onclick="openCollaboratorModal()">
              🔍 협조자 추가
            </button>
            <div id="selectedCollaborators" style="margin-top: 1rem;">
              <!-- 선택된 협조자들이 여기에 표시됩니다 -->
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" id="submitLeaveBtn">
              📝 연차 신청하기
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 📊 내 신청 현황 페이지 -->
    <div id="myRequestsPage" class="page">
      <div class="page-header">
        <h1 class="page-title">📊 내 신청 현황</h1>
        <p class="page-subtitle">내가 신청한 연차의 진행 상황을 확인하세요.</p>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>신청ID</th>
              <th>신청일</th>
              <th>연차 종류</th>
              <th>기간</th>
              <th>일수</th>
              <th>상태</th>
              <th>사유</th>
              <th>결재 현황</th>
            </tr>
          </thead>
          <tbody id="myRequestsTable">
            <tr>
              <td colspan="8" class="loading">내 신청 현황을 불러오는 중입니다</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ✅ 결재/협조 처리 페이지 -->
    <div id="approvalsPage" class="page">
      <div class="page-header">
        <h1 class="page-title">✅ 결재/협조 처리</h1>
        <p class="page-subtitle">나에게 할당된 결재 및 협조 건을 처리하세요.</p>
      </div>
      
      <!-- 결재 대기 목록 -->
      <div class="table-container" style="margin-bottom: 2rem;">
        <h3 style="padding: 1rem; margin: 0; background: #fff3cd; color: #856404; font-weight: 600;">
          🔶 결재 대기 목록
        </h3>
        <table class="table">
          <thead>
            <tr>
              <th>신청ID</th>
              <th>신청자</th>
              <th>연차 종류</th>
              <th>기간</th>
              <th>일수</th>
              <th>사유</th>
              <th>처리</th>
            </tr>
          </thead>
          <tbody id="pendingApprovalsTable">
            <tr>
              <td colspan="7" class="loading">결재 대기 목록을 불러오는 중입니다</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- 협조 대기 목록 -->
      <div class="table-container">
        <h3 style="padding: 1rem; margin: 0; background: #d1ecf1; color: #0c5460; font-weight: 600;">
          🔷 협조 대기 목록
        </h3>
        <table class="table">
          <thead>
            <tr>
              <th>신청ID</th>
              <th>신청자</th>
              <th>연차 종류</th>
              <th>기간</th>
              <th>일수</th>
              <th>사유</th>
              <th>처리</th>
            </tr>
          </thead>
          <tbody id="pendingCollaborationsTable">
            <tr>
              <td colspan="7" class="loading">협조 대기 목록을 불러오는 중입니다</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 📅 근무표 페이지 -->
    <div id="workSchedulePage" class="page">
      <div class="page-header">
        <h1 class="page-title">📅 근무표</h1>
        <p class="page-subtitle">부서별 월간 근무 현황을 확인하세요.</p>
      </div>
      
      <!-- 사용자 부서 정보 및 월 선택 -->
      <div class="schedule-controls">
        <div class="user-dept-info">
          <div class="dept-badge">
            <span class="dept-icon">🏢</span>
            <span class="dept-name" id="userDeptName">부서 정보 로딩 중...</span>
          </div>
        </div>
        
        <div class="form-grid" style="grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
          <div class="form-group">
            <label for="scheduleMonth">조회 월</label>
            <input type="month" id="scheduleMonth" onchange="loadWorkSchedule()">
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-primary" onclick="createWorkScheduleSheet()">
              <span>📋</span> 근무표 생성
            </button>
          </div>
        </div>
      </div>
      
      <!-- 근무표 컨테이너 -->
      <div class="work-schedule-container" id="workScheduleContainer">
        <div class="empty-state">
          <div class="empty-icon">📅</div>
          <h3>근무표를 선택해주세요</h3>
          <p>부서와 조회할 월을 선택하면 근무표가 표시됩니다.</p>
        </div>
      </div>
    </div>

    <!-- 👤 내 정보 페이지 -->
    <div id="myInfoPage" class="page">
      <div class="page-header">
        <h1 class="page-title">👤 내 정보</h1>
        <p class="page-subtitle">개인 정보와 연차 현황을 확인하세요.</p>
      </div>
      
      <div class="form-container">
        <div class="form-grid">
          <div class="form-group">
            <label>사번</label>
            <input type="text" value="<?= user.empId ?>" readonly>
          </div>
          
          <div class="form-group">
            <label>이름</label>
            <input type="text" value="<?= user.name ?>" readonly>
          </div>
          
          <div class="form-group">
            <label>이메일</label>
            <input type="text" value="<?= user.email ?>" readonly>
          </div>
          
          <div class="form-group">
            <label>소속 부서</label>
            <input type="text" id="myInfoDeptName" value="⏳ 로딩중..." readonly class="loading-input">
          </div>
          
          <div class="form-group">
            <label>직급</label>
            <input type="text" value="<?= user.position ?>" readonly>
          </div>
        </div>
        
        <div id="myLeaveInfo" class="dashboard-grid" style="margin-top: 2rem;">
          <!-- 연차 정보가 여기에 로드됩니다 -->
        </div>
      </div>
    </div>

    <!-- 🔑 비밀번호 변경 페이지 -->
    <div id="changePasswordPage" class="page">
      <div class="page-header">
        <h1 class="page-title">🔑 비밀번호 변경</h1>
        <p class="page-subtitle">보안을 위해 주기적으로 비밀번호를 변경하세요.</p>
      </div>
      
      <div class="form-container">
        <form id="changePasswordForm" onsubmit="changePassword(event)">
          <div class="form-group">
            <label for="currentPassword">현재 비밀번호 *</label>
            <input type="password" id="currentPassword" required>
          </div>
          
          <div class="form-group">
            <label for="newPassword">새 비밀번호 * (8자 이상)</label>
            <input type="password" id="newPassword" required minlength="8">
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">새 비밀번호 확인 *</label>
            <input type="password" id="confirmPassword" required minlength="8">
          </div>
          
          <div style="text-align: center; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              🔄 비밀번호 변경
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 🔧 관리자 메뉴 페이지 -->
    <? if (user.isAdmin) { ?>
    <!-- 🔧 관리자 메뉴 페이지 (더 이상 사용하지 않음 - 사이드바로 이동) -->
    <!--
    <div id="adminMenuPage" class="page">
      <div class="page-header">
        <h1 class="page-title">🔧 관리자 메뉴</h1>
        <p class="page-subtitle">시스템 관리 및 설정을 변경하세요.</p>
      </div>
      
      <div class="dashboard-grid">
        <div class="dashboard-card" onclick="showPage('employeeManagement')" style="cursor: pointer;">
          <div class="card-icon">👥</div>
          <div class="card-value">직원 관리</div>
          <div class="card-label">직원 추가/수정/삭제</div>
        </div>
        
        <div class="dashboard-card" onclick="showPage('departmentManagement')" style="cursor: pointer;">
          <div class="card-icon">🏢</div>
          <div class="card-value">부서 관리</div>
          <div class="card-label">부서 추가/수정/삭제</div>
        </div>
        
        <div class="dashboard-card" onclick="showPage('systemSettings')" style="cursor: pointer;">
          <div class="card-icon">⚙️</div>
          <div class="card-value">시스템 설정</div>
          <div class="card-label">연차 정책 및 설정</div>
        </div>
        
        <div class="dashboard-card" onclick="showPage('statistics')" style="cursor: pointer;">
          <div class="card-icon">📈</div>
          <div class="card-value">통계 및 백업</div>
          <div class="card-label">데이터 분석 및 백업</div>
        </div>
      </div>
    </div>
    -->

    <!-- 👥 직원 관리 페이지 -->
    <div id="employeeManagementPage" class="page">
      <div class="page-header">
        <h1 class="page-title">👥 직원 관리</h1>
        <p class="page-subtitle">직원 정보를 추가, 수정, 삭제할 수 있습니다.</p>
      </div>
      
      <!-- 직원 추가 섹션 -->
      <div class="employee-form-section">
        <div class="section-header">
          <h3 class="section-title">📝 직원 추가</h3>
        </div>
        
        <div class="form-container">
          <div class="info-banner">
            <div class="info-icon">📋</div>
            <div class="info-content">
              <strong>자동 생성 정보</strong>
              <ul class="info-list">
                <li>사번: 시스템에서 자동으로 생성됩니다 (기존 최대 사번 + 1)</li>
                <li>초기 비밀번호: <code>temp123</code> (첫 로그인 시 변경 필요)</li>
              </ul>
            </div>
          </div>
          
          <form id="addEmployeeForm" onsubmit="addEmployee(event)">
            <div class="form-grid">
              <div class="form-group">
                <label for="empName">이름 *</label>
                <input type="text" id="empName" required placeholder="홍길동">
              </div>
              
              <div class="form-group">
                <label for="empEmail">이메일 *</label>
                <input type="email" id="empEmail" required placeholder="hong@company.com">
              </div>
              
              <div class="form-group">
                <label for="empPhone">전화번호</label>
                <input type="tel" id="empPhone" placeholder="010-1234-5678">
              </div>
              
              <div class="form-group">
                <label for="empDept">부서 *</label>
                <select id="empDept" required>
                  <option value="">선택하세요</option>
                  <option value="10">개발팀</option>
                  <option value="20">영업팀</option>
                  <option value="30">인사팀</option>
                  <option value="40">총무팀</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="empPosition">직급</label>
                <input type="text" id="empPosition" placeholder="예: 대리">
              </div>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-large">
                <span class="btn-icon">👥</span>
                <span class="btn-text">직원 추가</span>
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- 직원 목록 섹션 -->
      <div class="employee-list-section">
        <div class="section-header">
          <h3 class="section-title">📋 직원 목록</h3>
          <div class="search-controls">
            <div class="search-input-wrapper">
              <input 
                type="text" 
                id="employeeSearchInput" 
                placeholder="🔍 이름, 이메일, 부서로 검색..." 
                class="search-input"
                onkeyup="searchEmployees()"
                onkeydown="if(event.key==='Enter'){event.preventDefault();searchEmployees();}"
              />
            </div>
            <button 
              type="button" 
              class="btn btn-secondary btn-reset" 
              onclick="clearEmployeeSearch()"
            >
              <span class="btn-icon">🔄</span>
              <span class="btn-text">초기화</span>
            </button>
          </div>
        </div>
        
                <div class="table-container">
          <table class="table employee-table">
          <thead>
            <tr>
                <th class="col-empid">사번</th>
                <th class="col-name">이름</th>
                <th class="col-email">이메일</th>
                <th class="col-dept">부서</th>
                <th class="col-position">직급</th>
                <th class="col-actions">관리</th>
            </tr>
          </thead>
          <tbody id="employeeListTable">
            <tr>
                <td colspan="6" class="loading-cell">직원 목록을 불러오는 중입니다</td>
            </tr>
          </tbody>
        </table>
        </div>
        
        <!-- 📄 페이지네이션 -->
        <div id="employeePagination" class="pagination-container" style="display: none;">
          <div class="pagination-info">
            <span id="paginationInfo">1-10 of 0 직원</span>
          </div>
          
          <div class="pagination-controls">
            <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)" title="첫 페이지">
              ⏮️
            </button>
            <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)" title="이전 페이지">
              ◀️
            </button>
            
            <div id="pageNumbers">
              <!-- 페이지 번호들이 여기에 동적으로 생성됩니다 -->
            </div>
            
            <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)" title="다음 페이지">
              ▶️
            </button>
            <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(totalPages)" title="마지막 페이지">
              ⏭️
            </button>
          </div>
          
          <div class="pagination-settings">
            <label for="itemsPerPage">페이지당:</label>
            <select id="itemsPerPage" class="pagination-select" onchange="changeItemsPerPage()">
              <option value="10">10개</option>
              <option value="20">20개</option>
              <option value="50">50개</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- 🏢 부서 관리 페이지 -->
    <div id="departmentManagementPage" class="page">
      <div class="page-header">
        <h1 class="page-title">🏢 부서 관리</h1>
        <p class="page-subtitle">부서 정보를 추가, 수정, 삭제하고 직원을 관리할 수 있습니다.</p>
      </div>
      
      <!-- 📝 컴팩트한 부서 추가 폼 -->
      <div class="compact-form-section">
        <div class="compact-form-header">
          <h3 class="compact-form-title">📝 부서 추가</h3>
        </div>
        
        <form id="addDepartmentForm" onsubmit="addDepartment(event)" class="compact-form">
          <div class="compact-form-row">
            <div class="compact-form-group">
              <label for="deptId">부서코드 *</label>
              <input type="number" id="deptId" required placeholder="예: 50">
            </div>
            
            <div class="compact-form-group">
              <label for="deptName">부서명 *</label>
              <input type="text" id="deptName" required placeholder="예: 마케팅팀">
            </div>
            
            <div class="compact-form-group">
              <button type="submit" class="btn-compact btn-compact-primary">
                🏢 부서 추가
              </button>
            </div>
          </div>
        </form>
      </div>
      
      <!-- 🏢 메인 부서 관리 섹션 -->
      <div class="department-management-main">
        <div class="main-section-header">
          <div class="section-title-area">
            <h3 class="main-section-title">📊 부서 현황 및 직원 관리</h3>
            <p class="main-section-subtitle">부서 정보를 관리하고 직원을 부서간 이동할 수 있습니다</p>
          </div>
          <div class="view-controls">
            <!-- 뷰 전환 탭 -->
            <div class="view-tabs">
              <button 
                type="button" 
                class="view-tab active" 
                id="deptListViewTab"
                onclick="switchDepartmentView('list')"
              >
                <span class="tab-icon">📋</span>
                <span class="tab-text">목록 뷰</span>
              </button>
              <button 
                type="button" 
                class="view-tab" 
                id="deptBoardViewTab"
                onclick="switchDepartmentView('board')"
              >
                <span class="tab-icon">🎯</span>
                <span class="tab-text">보드 뷰</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- 목록 뷰 (기본) -->
        <div id="departmentListView" class="department-view active">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>부서코드</th>
                  <th>부서명</th>
                  <th>소속 직원 수</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="departmentListTable">
                <tr>
                  <td colspan="4" class="loading">부서 목록을 불러오는 중입니다</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- 🎯 드래그 앤 드롭 보드 뷰 -->
        <div id="departmentBoardView" class="department-view">
          <div class="board-container">
            <div class="board-header">
              <div class="board-info">
                <h4 class="board-title">🎯 부서별 직원 관리 보드</h4>
                <p class="board-subtitle">직원 카드를 드래그해서 다른 부서로 이동시키세요</p>
              </div>
              <div class="board-stats">
                <span id="deptBoardTotalEmployees" class="board-stat">총 <strong>0</strong>명</span>
                <span id="deptBoardTotalDepartments" class="board-stat"><strong>0</strong>개 부서</span>
              </div>
            </div>
            
            <div class="kanban-board" id="deptKanbanBoard">
              <!-- 부서별 칼럼들이 여기에 동적으로 생성됩니다 -->
              <div class="board-loading">
                <div class="spinner"></div>
                <p>부서별 직원 보드를 불러오는 중입니다...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ⚙️ 시스템 설정 페이지 -->
    <div id="systemSettingsPage" class="page">
      <div class="page-header">
        <h1 class="page-title">⚙️ 설정</h1>
        <p class="page-subtitle">연차 정책 및 시스템 설정을 관리합니다.</p>
      </div>
      
      <div class="form-container">
        <h3>📋 연차 정책 설정</h3>
        <form id="systemSettingsForm" onsubmit="updateSystemSettings(event)">
          <div class="form-grid">
            <div class="form-group">
              <label for="basicLeaves">기본 연차 일수</label>
              <input type="number" id="basicLeaves" value="15" min="10" max="30">
            </div>
            
            <div class="form-group">
              <label for="maxLeaves">최대 연차 일수</label>
              <input type="number" id="maxLeaves" value="25" min="15" max="50">
            </div>
            
            <div class="form-group">
              <label for="sessionTimeout">세션 타임아웃 (분)</label>
              <input type="number" id="sessionTimeout" value="120" min="30" max="480">
            </div>
            
            <div class="form-group">
              <label for="leavePolicy">연차 발생 기준</label>
              <select id="leavePolicy">
                <option value="입사일 기준">입사일 기준</option>
                <option value="회계연도 기준">회계연도 기준</option>
              </select>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              ⚙️ 설정 저장
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 📈 통계 및 백업 페이지 -->
    <div id="statisticsPage" class="page">
      <div class="page-header">
        <h1 class="page-title">📈 통계 및 보고서</h1>
        <p class="page-subtitle">실시간 통계와 운영 인사이트를 확인하세요.</p>
      </div>
      
      <!-- 🔥 실시간 운영 지표 -->
      <div class="stats-section">
        <h3 class="stats-section-title">🔥 실시간 운영 현황</h3>
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-icon">⏰</div>
            <div class="card-value" id="statsPendingRequests">-</div>
            <div class="card-label">처리 대기 중</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">📅</div>
            <div class="card-value" id="statsThisMonthRequests">-</div>
            <div class="card-label">이번 달 신청</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">⚡</div>
            <div class="card-value" id="statsAvgProcessTime">-</div>
            <div class="card-label">평균 처리시간</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">📊</div>
            <div class="card-value" id="statsApprovalRate">-</div>
            <div class="card-label">승인률</div>
          </div>
        </div>
      </div>
      
      <!-- 📊 핵심 성과 지표 -->
      <div class="stats-section">
        <h3 class="stats-section-title">📊 핵심 성과 지표 (KPI)</h3>
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-icon">👥</div>
            <div class="card-value" id="statsEmployeeCount">-</div>
            <div class="card-label">전체 직원 수</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">📈</div>
            <div class="card-value" id="statsAvgLeaveUsage">-</div>
            <div class="card-label">1인당 평균 사용</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">🏢</div>
            <div class="card-value" id="statsDepartmentCount">-</div>
            <div class="card-label">운영 부서 수</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-icon">🎯</div>
            <div class="card-value" id="statsSystemHealth">-</div>
            <div class="card-label">시스템 건전성</div>
          </div>
        </div>
      </div>
      
      <!-- 📋 부서별 현황 -->
      <div class="stats-section">
        <h3 class="stats-section-title">📋 부서별 연차 사용 현황</h3>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>부서명</th>
                <th>직원 수</th>
                <th>평균 사용률</th>
                <th>잔여 연차</th>
                <th>상태</th>
              </tr>
            </thead>
            <tbody id="departmentStatsTable">
              <tr>
                <td colspan="5" class="loading">부서별 현황을 불러오는 중입니다</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 💾 데이터 관리 -->
      <div class="stats-section">
        <h3 class="stats-section-title">💾 데이터 관리</h3>
        <div class="data-management-grid">
          <div class="data-action-card">
            <div class="action-icon">📥</div>
            <div class="action-title">데이터 내보내기</div>
            <div class="action-desc">Excel 형태로 통계 데이터 다운로드</div>
            <button type="button" class="btn btn-secondary" onclick="exportData()">
              📥 내보내기
            </button>
          </div>
          
          <div class="data-action-card">
            <div class="action-icon">💾</div>
            <div class="action-title">시스템 백업</div>
            <div class="action-desc">전체 데이터 백업 파일 생성</div>
            <button type="button" class="btn btn-primary" onclick="backupData()">
              💾 백업 생성
            </button>
          </div>
          
          <div class="data-action-card">
            <div class="action-icon">🔄</div>
            <div class="action-title">통계 새로고침</div>
            <div class="action-desc">최신 데이터로 통계 업데이트</div>
            <button type="button" class="btn btn-success" onclick="loadStatistics()">
              🔄 새로고침
            </button>
          </div>
        </div>
      </div>
    </div>
    <? } ?>

  </main>

  <!-- 🔧 직원 수정 모달 -->
  <div id="editEmployeeModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">✏️ 직원 정보 수정</h3>
        <button class="modal-close" onclick="closeEditEmployeeModal()">×</button>
      </div>
      
      <div class="modal-body">
        <form id="editEmployeeForm">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group-modal">
                <label for="editEmpId">사번</label>
                <input type="text" id="editEmpId" readonly>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group-modal">
                <label for="editEmpName">이름 *</label>
                <input type="text" id="editEmpName" required>
              </div>
            </div>
          </div>
          
          <div class="form-group-modal">
            <label for="editEmpEmail">이메일 *</label>
            <input type="email" id="editEmpEmail" required>
          </div>
          
          <div class="form-group-modal">
            <label for="editEmpPhone">전화번호</label>
            <input type="tel" id="editEmpPhone" placeholder="010-1234-5678">
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group-modal">
                <label for="editEmpDept">부서 *</label>
                <select id="editEmpDept" required>
                  <option value="">선택하세요</option>
                  <!-- 부서 옵션들이 JavaScript로 동적 로드됩니다 -->
                </select>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group-modal">
                <label for="editEmpPosition">직급</label>
                <input type="text" id="editEmpPosition" placeholder="예: 대리">
              </div>
            </div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="resetPasswordCheckbox">
            <label for="resetPasswordCheckbox">🔑 비밀번호를 temp123으로 초기화</label>
          </div>
          
          <div id="editEmployeeMessage" class="alert" style="display: none; margin-top: 1rem;"></div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeEditEmployeeModal()">
          <span>🚫</span> 취소
        </button>
        <button type="button" class="btn-modal btn-modal-primary" onclick="saveEmployeeChanges()">
          <span>💾</span> 저장
        </button>
      </div>
    </div>
  </div>

  <!-- 🏢 부서 수정 모달 (관리자 전용) -->
  <!-- 일반 직원에게는 불필요하므로 주석 처리 -->
  <!--
  <div id="editDepartmentModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">🏢 부서 정보 수정</h3>
        <button class="modal-close" onclick="closeEditDepartmentModal()">×</button>
      </div>
      
      <div class="modal-body">
        <form id="editDepartmentForm">
          <div class="form-group-modal">
            <label for="editDeptId">부서코드</label>
            <input type="text" id="editDeptId" readonly>
          </div>
          
          <div class="form-group-modal">
            <label for="editDeptName">부서명 *</label>
            <input type="text" id="editDeptName" required placeholder="예: 마케팅팀">
          </div>
          
          <div class="info-banner" style="margin-top: 1rem;">
            <div class="info-icon">ℹ️</div>
            <div class="info-content">
              <strong>부서 수정 안내</strong>
              <ul class="info-list">
                <li>부서코드는 변경할 수 없습니다 (시스템 무결성 보장)</li>
                <li>부서명은 다른 부서와 중복될 수 없습니다</li>
                <li>소속 직원들에게 자동으로 변경사항이 반영됩니다</li>
              </ul>
            </div>
          </div>
          
          <div id="editDepartmentMessage" class="alert" style="display: none; margin-top: 1rem;"></div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeEditDepartmentModal()">
          <span>🚫</span> 취소
        </button>
        <button type="button" class="btn-modal btn-modal-primary" onclick="saveDepartmentChanges()">
          <span>💾</span> 저장
        </button>
      </div>
    </div>
  </div>
  -->

  <!-- 사용자 정보를 JavaScript에서 사용할 수 있도록 숨겨진 요소로 전달 -->
  <div id="userInfo" style="display: none;">
    <span id="userEmpId"><?= typeof user !== 'undefined' && user.empId ? user.empId : 'UNKNOWN' ?></span>
    <span id="userName"><?= typeof user !== 'undefined' && user.name ? user.name : '사용자' ?></span>
    <span id="userEmail"><?= typeof user !== 'undefined' && user.email ? user.email : 'unknown@company.com' ?></span>
    <span id="userPosition"><?= typeof user !== 'undefined' && user.position ? user.position : '직원' ?></span>
    <span id="userIsAdmin"><?= typeof user !== 'undefined' && user.isAdmin ? user.isAdmin : false ?></span>
    <span id="userDepartment"><?= typeof user !== 'undefined' && user.department ? user.department : '미지정' ?></span>
  </div>
  


  <!-- 🔧 JavaScript -->
  <script>
    // 📚 전역 변수 (숨겨진 HTML 요소에서 가져옴)
    var currentUser = {};
    var allEmployees = []; // 전역 직원 목록 저장
    
    // 📄 페이지네이션 전역 변수
    var currentPage = 1;
    var itemsPerPage = 10;
    var totalPages = 1;
    var filteredEmployees = []; // 검색 필터링된 직원 목록
    
    // 안전한 사용자 정보 로드
    try {
      const userEmpIdEl = document.getElementById('userEmpId');
      const userNameEl = document.getElementById('userName');
      const userEmailEl = document.getElementById('userEmail');
      const userPositionEl = document.getElementById('userPosition');
      const userIsAdminEl = document.getElementById('userIsAdmin');
      
      if (userEmpIdEl && userNameEl && userEmailEl && userPositionEl && userIsAdminEl) {
        currentUser = {
          empId: userEmpIdEl.textContent || 'UNKNOWN',
          name: userNameEl.textContent || '사용자',
          email: userEmailEl.textContent || 'unknown@company.com',
          position: userPositionEl.textContent || '직원',
          isAdmin: userIsAdminEl.textContent === 'true'
        };
        console.log('✅ 사용자 정보 로드 성공:', currentUser);
      } else {
        console.error('❌ 사용자 정보 요소를 찾을 수 없습니다');
        currentUser = {
          empId: 'ERROR',
          name: '오류',
          email: 'error@company.com',
          position: '오류',
          isAdmin: false
        };
      }
    } catch (error) {
      console.error('❌ 사용자 정보 로드 오류:', error);
      currentUser = {
        empId: 'ERROR',
        name: '오류',
        email: 'error@company.com',
        position: '오류',
        isAdmin: false
      };
    }
    
    // 전역 변수 선언 (연차 신청용)
    var selectedApprovers = [];
    var selectedCollaborators = [];
    
    /**
     * 🚀 페이지 로드 시 초기화
     */
    window.addEventListener('load', function() {
      try {
        // 사용자 정보 로드
        currentUser = {
          empId: document.getElementById('userEmpId')?.textContent || 'UNKNOWN',
          name: document.getElementById('userName')?.textContent || '사용자',
          email: document.getElementById('userEmail')?.textContent || 'unknown@company.com',
          position: document.getElementById('userPosition')?.textContent || '직원',
          isAdmin: document.getElementById('userIsAdmin')?.textContent === 'true',
          department: document.getElementById('userDepartment')?.textContent || '미지정'
        };

        // 사용자 정보 유효성 검사
        if (currentUser.empId === 'UNKNOWN') {
          showErrorMessage('사용자 정보를 불러올 수 없습니다. 페이지를 새로고침하거나 다시 로그인해주세요.');
          return;
        }
        
        // 기본 UI 초기화
        initializeUI();
        
        // 대시보드 페이지 표시
        showPage('dashboard');
        
        // 대시보드 데이터 로드
        loadDashboardData();
      } catch (error) {
        console.error('❌ 시스템 초기화 오류:', error);
        showErrorMessage('시스템 초기화 중 오류가 발생했습니다.');
      }
    });
    

    
    /**
     * 🎨 UI 초기화
     */
    function initializeUI() {
      // 사용자명 표시 확인
      const userButtons = document.querySelectorAll('.user-button');
      userButtons.forEach(button => {
        if (button.textContent.includes('<?= user.name ?>')) {
          button.innerHTML = `👤 ${currentUser.name} <span style="margin-left: 0.5rem;">▼</span>`;
        }
      });
      
      // 대시보드 인사말 업데이트
      const subtitle = document.querySelector('.page-subtitle');
      if (subtitle && subtitle.textContent.includes('<?= user.name ?>')) {
        subtitle.textContent = `안녕하세요, ${currentUser.name}님! 연차 현황을 확인해보세요.`;
      }
      
      console.log('✅ UI 초기화 완료');
    }
    
    /**
     * ❌ 오류 메시지 표시
     */
    function showErrorMessage(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 5px; z-index: 9999; border: 1px solid #f5c6cb;';
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        document.body.removeChild(errorDiv);
      }, 5000);
    }
    
    /**
     * 📄 페이지 전환 함수
     */
    function showPage(pageId) {
      console.log('페이지 전환:', pageId);
      
      // userManagement를 employeeManagement로 리다이렉트 (호환성)
      if (pageId === 'userManagement') {
        pageId = 'employeeManagement';
      }
      
      // 모든 페이지 숨김
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // 모든 메뉴 비활성화
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // 선택된 페이지 표시
      const targetPage = document.getElementById(pageId + 'Page');
      if (targetPage) {
        targetPage.classList.add('active');
      }
      
      // 해당 메뉴 활성화 (정확한 선택자 사용)
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        const onclick = item.getAttribute('onclick');
        if (onclick && onclick.includes(`showPage('${pageId}')`)) {
          item.classList.add('active');
          console.log('메뉴 활성화:', pageId);
        }
      });
      
      // 페이지별 데이터 로드
      loadPageData(pageId);
      
      // 사용자 드롭다운 닫기
      hideUserMenu();
    }
    
    /**
     * 🏷️ 페이지 제목 매핑
     */
    function getPageTitle(pageId) {
      const titles = {
        'dashboard': '대시보드',
        'leaveRequest': '연차 신청',
        'myRequests': '내 신청 현황',
        'approvals': '결재/협조 처리',
        'myInfo': '내 정보',
        'changePassword': '비밀번호 변경',
        'adminMenu': '관리자 메뉴',
        'employeeManagement': '직원 관리',
        'userManagement': '직원 관리', // 관리자 메뉴용 별칭
        'departmentManagement': '부서 관리',
        'systemSettings': '설정',
        'statistics': '통계 및 보고서'
      };
      return titles[pageId] || '';
    }
    
    /**
     * 📊 대시보드 데이터 로드
     */
    async function loadDashboardData() {
      try {
        console.log('대시보드 데이터 로드 중...');
        
        if (currentUser.isAdmin) {
          // 관리자용 시스템 현황 데이터 로드
          const systemStats = await callServerFunction('getSystemStatistics');
          const departments = await callServerFunction('getDepartmentsQuick');
          
          if (systemStats) {
            document.getElementById('totalEmployees').textContent = systemStats.totalEmployees || '0';
            document.getElementById('totalRequests').textContent = systemStats.totalRequests || '0';
            document.getElementById('approvedRequests').textContent = systemStats.approvedRequests || '0';
            document.getElementById('totalDepartments').textContent = departments ? departments.length : '0';
          }
        } else {
          // 직원용 개인 연차 데이터 로드 (빠른 함수 사용)
          const myLeaveInfo = await callServerFunction('getMyLeaveInfoFast', currentUser.empId);
          
          if (myLeaveInfo) {
            // 대시보드 카드 업데이트
            document.getElementById('remainingLeaves').textContent = myLeaveInfo.remainingLeaves || '15';
            document.getElementById('pendingRequests').textContent = myLeaveInfo.pendingRequests || '0';
            document.getElementById('pendingApprovals').textContent = myLeaveInfo.pendingApprovals || '0';
            document.getElementById('thisMonthUsed').textContent = myLeaveInfo.thisYearUsed || '0';
            
            // 부서 정보도 함께 업데이트 (로딩 상태 제거)
            const deptBadge = document.getElementById('dashboardDeptBadge');
            if (deptBadge) {
              deptBadge.classList.remove('loading-badge');
              deptBadge.innerHTML = myLeaveInfo.deptName || '부서 미지정';
              console.log('✅ 대시보드 부서 정보 업데이트 완료:', myLeaveInfo.deptName);
            }
            
            // 최근 신청 내역 로드
            loadRecentRequests();
          }
        }
        
      } catch (error) {
        console.error('대시보드 데이터 로드 오류:', error);
        // 기본값 설정
        if (currentUser.isAdmin) {
          if (document.getElementById('totalEmployees')) document.getElementById('totalEmployees').textContent = '0';
          if (document.getElementById('totalRequests')) document.getElementById('totalRequests').textContent = '0';
          if (document.getElementById('approvedRequests')) document.getElementById('approvedRequests').textContent = '0';
          if (document.getElementById('totalDepartments')) document.getElementById('totalDepartments').textContent = '0';
        } else {
          if (document.getElementById('remainingLeaves')) document.getElementById('remainingLeaves').textContent = '15';
          if (document.getElementById('pendingRequests')) document.getElementById('pendingRequests').textContent = '0';
          if (document.getElementById('pendingApprovals')) document.getElementById('pendingApprovals').textContent = '0';
          if (document.getElementById('thisMonthUsed')) document.getElementById('thisMonthUsed').textContent = '0';
          
          // 오류 시에도 부서 배지 로딩 상태 제거
          const deptBadge = document.getElementById('dashboardDeptBadge');
          if (deptBadge) {
            deptBadge.classList.remove('loading-badge');
            deptBadge.innerHTML = '부서 정보 로드 실패';
          }
        }
      }
    }
    
    /**
     * 📝 최근 신청 내역 로드
     */
    async function loadRecentRequests() {
      try {
        const recentRequests = await callServerFunction('getRecentRequests', currentUser.empId);
        const tableBody = document.getElementById('recentRequestsTable');
        
        if (recentRequests && recentRequests.length > 0) {
          tableBody.innerHTML = recentRequests.map(request => `
            <tr>
              <td>${formatDate(request.submitDate)}</td>
              <td>${request.leaveType}</td>
              <td>${formatDate(request.startDate)} ~ ${formatDate(request.endDate)}</td>
              <td><span class="status-badge status-${getStatusClass(request.status)}">${request.status}</span></td>
              <td>${request.reason}</td>
            </tr>
          `).join('');
        } else {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">최근 신청 내역이 없습니다.</td></tr>';
        }
        
      } catch (error) {
        console.error('최근 신청 내역 로드 오류:', error);
        document.getElementById('recentRequestsTable').innerHTML = 
          '<tr><td colspan="5" style="text-align: center; color: #dc3545;">데이터를 불러올 수 없습니다.</td></tr>';
      }
    }
    
    /**
     * 📄 페이지별 데이터 로드
     */
    function loadPageData(pageId) {
      try {
        // 페이지 전환 전 모든 모달 닫기
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          modal.style.display = 'none';
        });

        switch (pageId) {
          case 'dashboard':
            loadDashboardData();
            break;
          case 'myRequests':
            loadMyRequests();
            break;
          case 'approvals':
            loadApprovals();
            break;
          case 'myInfo':
            loadMyInfo();
            break;
          case 'workSchedule':
            loadWorkSchedulePage();
            break;
          case 'leaveRequest':
            initializeLeaveRequestForm();
            break;
          case 'employeeManagement':
            if (currentUser.isAdmin) {
              loadEmployeeManagement();
            }
            break;
          case 'departmentManagement':
            if (currentUser.isAdmin) {
              loadDepartmentManagement();
            }
            break;
          case 'systemSettings':
            if (currentUser.isAdmin) {
              loadSystemSettings();
            }
            break;
          case 'statistics':
            loadStatistics();
            break;
          default:
            console.warn('⚠️ 알 수 없는 페이지:', pageId);
        }
      } catch (error) {
        console.error('❌ 페이지 데이터 로드 오류:', error);
        showErrorMessage('페이지 데이터를 불러올 수 없습니다.');
      }
    }
    
    /**
     * 📞 서버 함수 호출 헬퍼
     */
    function callServerFunction(functionName, ...args) {
      return new Promise((resolve, reject) => {
        try {
          // Google Apps Script 환경 확인
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            throw new Error('Google Apps Script 환경이 아닙니다. 구글 시트에서 실행해주세요.');
          }

          // 함수 존재 여부 확인
          if (!google.script.run[functionName]) {
            throw new Error(`서버 함수 '${functionName}'을 찾을 수 없습니다.`);
          }

          console.log(`📞 서버 함수 호출: ${functionName}(${args.join(', ')})`);
          
          // 타임아웃 설정 (30초)
          const timeoutId = setTimeout(() => {
            reject(new Error(`서버 함수 '${functionName}' 호출 시간이 초과되었습니다. (30초)`));
          }, 30000);

          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              console.log(`✅ 서버 함수 성공: ${functionName}`, result);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              console.error(`❌ 서버 함수 실패: ${functionName}`, error);
              
              // 에러 메시지 정리
              let errorMessage = '서버 오류가 발생했습니다.';
              if (error && typeof error === 'string') {
                errorMessage = error;
              } else if (error && error.message) {
                errorMessage = error.message;
              } else if (error && error.toString) {
                errorMessage = error.toString();
              }
              
              reject(new Error(errorMessage));
            })
            [functionName](...args);
            
        } catch (error) {
          console.error(`❌ 서버 함수 호출 오류: ${functionName}`, error);
          reject(error);
        }
      });
    }
    
    /**
     * 📅 날짜 포맷팅
     */
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('ko-KR');
    }
    
    /**
     * 🏷️ 상태별 CSS 클래스
     */
    function getStatusClass(status) {
      switch (status) {
        case '대기': return 'pending';
        case '승인': return 'approved';
        case '반려': return 'rejected';
        default: return 'pending';
      }
    }
    
    /**
     * 👤 사용자 메뉴 토글
     */
    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      const isVisible = dropdown.style.display === 'block';
      dropdown.style.display = isVisible ? 'none' : 'block';
    }
    
    /**
     * 🙈 사용자 메뉴 숨김
     */
    function hideUserMenu() {
      document.getElementById('userDropdown').style.display = 'none';
    }
    
    /**
     * 🔔 알림 표시
     */
    function showNotifications() {
      alert('알림 기능은 개발 중입니다.');
    }
    
    /**
     * 📝 연차 신청 폼 초기화
     */
    function initializeLeaveRequestForm() {
      // 오늘 날짜를 기본값으로 설정
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;
      
      // 선택된 결재자/협조자 초기화
      selectedApprovers = [];
      selectedCollaborators = [];
      updateSelectedApprovers();
      updateSelectedCollaborators();
    }
    
    /**
     * 📅 연차 일수 자동 계산
     */
    function calculateLeaveDays() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const leaveType = document.getElementById('leaveType').value;
      
      if (startDate && endDate && leaveType) {
        const days = calculateDays(startDate, endDate, leaveType);
        document.getElementById('calculatedDays').value = days + '일';
      } else {
        document.getElementById('calculatedDays').value = '';
      }
    }
    
    /**
     * 📝 연차 신청 제출
     */
    async function submitLeaveRequest(event) {
      event.preventDefault();
      
      if (selectedApprovers.length === 0) {
        alert('결재자를 최소 1명 이상 선택해주세요.');
        return;
      }
      
      // 필수 필드 검증
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const leaveType = document.getElementById('leaveType').value;
      const reason = document.getElementById('reason').value;
      
      if (!startDate || !endDate || !leaveType || !reason) {
        alert('모든 필수 항목을 입력해주세요.');
        return;
      }
      
      // 연차 일수 계산
      const days = calculateLeaveDaysForSubmit(startDate, endDate, leaveType);
      
      const formData = {
        empId: currentUser.empId, // 현재 사용자 ID
        startDate: startDate,
        endDate: endDate,
        days: days, // 계산된 일수
        leaveType: leaveType,
        reason: reason,
        approvers: selectedApprovers.map(a => a.empId), // 결재자 ID 배열
        collaborators: selectedCollaborators.map(c => c.empId) // 협조자 ID 배열
      };
      
      try {
        console.log('연차 신청 데이터:', formData);
        showLoading(true);
        const result = await callServerFunction('submitLeaveRequest', formData);
        
        console.log('서버 응답:', result);
        
        if (result && result.success) {
          showNotification('연차 신청이 완료되었습니다!', 'success');
          document.getElementById('leaveRequestForm').reset();
          selectedApprovers = [];
          selectedCollaborators = [];
          updateSelectedApprovers();
          updateSelectedCollaborators();
          showPage('myRequests');
        } else {
          const errorMessage = result && result.message ? result.message : '알 수 없는 오류가 발생했습니다.';
          showNotification('연차 신청 중 오류가 발생했습니다: ' + errorMessage, 'error');
        }
      } catch (error) {
        console.error('연차 신청 오류:', error);
        showNotification('연차 신청 중 오류가 발생했습니다: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }
    
    // 연차 신청용 전체 직원 목록 변수
    let leaveEmployeeList = []; // 전체 직원 목록
    
    /**
     * 👥 결재자 선택 모달 열기
     */
    async function openApproverModal() {
      try {
        // 로딩 표시 시작
        showLoading(true);

        // 직원 목록 로드
        const employees = await callServerFunction('getEmployeesForWeb');
        if (!employees || !Array.isArray(employees)) {
          throw new Error('직원 목록을 불러올 수 없습니다.');
        }

        // 현재 사용자 ID
        const currentUserId = document.getElementById('userEmpId')?.textContent;
        if (!currentUserId) {
          throw new Error('사용자 정보를 찾을 수 없습니다.');
        }

        // 모달 생성 및 스타일 적용
        const modalHtml = `
          <div class="modal-overlay" id="approverModal">
            <div class="modal-container" style="width: 80%; max-width: 800px; max-height: 80vh; margin: 10vh auto;">
              <div class="modal-header">
                <h3>결재자/협조자 선택</h3>
                <button class="close-button" onclick="closeApproverModal()">×</button>
              </div>
              <div class="modal-body" style="max-height: calc(80vh - 180px); overflow-y: auto;">
                <div class="search-box">
                  <input type="text" id="employeeSearchInput" placeholder="이름 또는 부서로 검색..." 
                         onkeyup="filterEmployees(this.value)">
                </div>
                <div id="employeeList" class="employee-list">
                  ${employees
                    .filter(emp => emp && emp.empId && emp.empId !== currentUserId)
                    .map(emp => `
                      <div class="employee-item ${selectedApprovers.some(a => a.empId === emp.empId) ? 'selected' : ''}"
                           data-employee='${JSON.stringify(emp)}'
                           onclick="toggleLeaveApprover(this.dataset.employee)">
                        <div class="employee-info">
                          <div class="employee-name">${emp.name || '이름 없음'}</div>
                          <div class="employee-position">${emp.position || '직급 미지정'}</div>
                        </div>
                        <div class="employee-dept">${emp.deptName || '부서 미지정'}</div>
                      </div>
                    `).join('')}
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeApproverModal()">취소</button>
                <button class="btn-modal btn-modal-primary" onclick="confirmApprovers()">확인</button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달이 있다면 제거
        const existingModal = document.getElementById('approverModal');
        if (existingModal) {
          existingModal.remove();
        }

        // 새 모달 추가
        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (error) {
        console.error('결재자 모달 오류:', error);
        showNotification('결재자 선택 모달을 열 수 없습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    /**
     * 🤝 협조자 선택 모달 열기
     */
    async function openCollaboratorModal() {
      try {
        // 로딩 표시 시작
        showLoading(true);

        // 직원 목록 로드
        const employees = await callServerFunction('getEmployeesForWeb');
        if (!employees || !Array.isArray(employees)) {
          throw new Error('직원 목록을 불러올 수 없습니다.');
        }

        // 현재 사용자 ID
        const currentUserId = document.getElementById('userEmpId')?.textContent;
        if (!currentUserId) {
          throw new Error('사용자 정보를 찾을 수 없습니다.');
        }

        // 모달 생성 및 스타일 적용
        const modalHtml = `
          <div class="modal-overlay" id="collaboratorModal">
            <div class="modal-container" style="width: 80%; max-width: 800px; max-height: 80vh; margin: 10vh auto;">
              <div class="modal-header">
                <h3>협조자 선택</h3>
                <button class="close-button" onclick="closeCollaboratorModal()">×</button>
              </div>
              <div class="modal-body" style="max-height: calc(80vh - 180px); overflow-y: auto;">
                <div class="search-box">
                  <input type="text" id="employeeSearchInput" placeholder="이름 또는 부서로 검색..." 
                         onkeyup="filterEmployees(this.value)">
                </div>
                <div id="employeeList" class="employee-list">
                  ${employees
                    .filter(emp => emp && emp.empId && emp.empId !== currentUserId)
                    .map(emp => `
                      <div class="employee-item ${selectedCollaborators.some(c => c.empId === emp.empId) ? 'selected' : ''}"
                           data-employee='${JSON.stringify(emp)}'
                           onclick="toggleLeaveCollaborator(this.dataset.employee)">
                        <div class="employee-info">
                          <div class="employee-name">${emp.name || '이름 없음'}</div>
                          <div class="employee-position">${emp.position || '직급 미지정'}</div>
                        </div>
                        <div class="employee-dept">${emp.deptName || '부서 미지정'}</div>
                      </div>
                    `).join('')}
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeCollaboratorModal()">취소</button>
                <button class="btn-modal btn-modal-primary" onclick="confirmCollaborators()">확인</button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달이 있다면 제거
        const existingModal = document.getElementById('collaboratorModal');
        if (existingModal) {
          existingModal.remove();
        }

        // 새 모달 추가
        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (error) {
        console.error('협조자 모달 오류:', error);
        showNotification('협조자 선택 모달을 열 수 없습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    /**
     * 📅 연차 일수 계산 (화면 표시용)
     */
    function calculateLeaveDays() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const leaveType = document.getElementById('leaveType').value;
      
      if (!startDate || !endDate || !leaveType) {
        document.getElementById('calculatedDays').value = '';
        return;
      }
      
      const calculatedDays = calculateLeaveDaysForSubmit(startDate, endDate, leaveType);
      document.getElementById('calculatedDays').value = calculatedDays + '일';
    }

    /**
     * 📅 연차 일수 계산 (서버 전송용)
     */
    function calculateLeaveDaysForSubmit(startDate, endDate, leaveType) {
      if (!startDate || !endDate || !leaveType) {
        return 0;
      }
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      
      let calculatedDays = 0;
      
      switch (leaveType) {
        case '연차':
          calculatedDays = diffDays;
          break;
        case '반차':
          calculatedDays = 0.5;
          break;
        case '특별휴가':
          calculatedDays = diffDays;
          break;
        default:
          calculatedDays = 0;
      }
      
      return calculatedDays;
    }

    /**
     * 👥 결재자 토글 선택
     */
    function toggleLeaveApprover(employeeData) {
      const employee = JSON.parse(employeeData);
      const index = selectedApprovers.findIndex(a => a.empId === employee.empId);
      
      if (index > -1) {
        selectedApprovers.splice(index, 1);
      } else {
        selectedApprovers.push(employee);
      }
      
      updateSelectedApprovers();
    }

    /**
     * 🤝 협조자 토글 선택
     */
    function toggleLeaveCollaborator(employeeData) {
      const employee = JSON.parse(employeeData);
      const index = selectedCollaborators.findIndex(c => c.empId === employee.empId);
      
      if (index > -1) {
        selectedCollaborators.splice(index, 1);
      } else {
        selectedCollaborators.push(employee);
      }
      
      updateSelectedCollaborators();
    }

    /**
     * 👥 선택된 결재자 업데이트
     */
    function updateSelectedApprovers() {
      const container = document.getElementById('selectedApprovers');
      if (!container) return;
      
      if (selectedApprovers.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">선택된 결재자가 없습니다.</p>';
        return;
      }
      
      container.innerHTML = selectedApprovers.map((approver, index) => `
        <div class="selected-employee">
          <span class="employee-name">${approver.name}</span>
          <span class="employee-dept">${approver.deptName}</span>
          <button type="button" class="btn-remove" onclick="removeApprover(${index})">×</button>
        </div>
      `).join('');
    }

    /**
     * 🤝 선택된 협조자 업데이트
     */
    function updateSelectedCollaborators() {
      const container = document.getElementById('selectedCollaborators');
      if (!container) return;
      
      if (selectedCollaborators.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">선택된 협조자가 없습니다.</p>';
        return;
      }
      
      container.innerHTML = selectedCollaborators.map((collaborator, index) => `
        <div class="selected-employee">
          <span class="employee-name">${collaborator.name}</span>
          <span class="employee-dept">${collaborator.deptName}</span>
          <button type="button" class="btn-remove" onclick="removeCollaborator(${index})">×</button>
        </div>
      `).join('');
    }

    /**
     * ❌ 결재자 제거
     */
    function removeApprover(index) {
      selectedApprovers.splice(index, 1);
      updateSelectedApprovers();
    }

    /**
     * ❌ 협조자 제거
     */
    function removeCollaborator(index) {
      selectedCollaborators.splice(index, 1);
      updateSelectedCollaborators();
    }

    /**
     * ✅ 결재자 확인
     */
    function confirmApprovers() {
      closeApproverModal();
      updateSelectedApprovers();
    }

    /**
     * ✅ 협조자 확인
     */
    function confirmCollaborators() {
      closeCollaboratorModal();
      updateSelectedCollaborators();
    }

    /**
     * ❌ 결재자 모달 닫기
     */
    function closeApproverModal() {
      const modal = document.getElementById('approverModal');
      if (modal) {
        modal.remove();
      }
    }

    /**
     * ❌ 협조자 모달 닫기
     */
    function closeCollaboratorModal() {
      const modal = document.getElementById('collaboratorModal');
      if (modal) {
        modal.remove();
      }
    }

    /**
     * 🔍 직원 목록 필터링
     */
    function filterEmployees(keyword) {
      const employees = Array.from(document.querySelectorAll('.employee-item'));
      employees.forEach(item => {
        const name = item.querySelector('.employee-name').textContent.toLowerCase();
        const dept = item.querySelector('.employee-dept').textContent.toLowerCase();
        const keywordLower = keyword.toLowerCase();
        
        if (name.includes(keywordLower) || dept.includes(keywordLower)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    /**
     * 🔍 결재자 목록 필터링
     */
    function filterLeaveApproverList(keyword) {
      const employees = Array.from(document.querySelectorAll('#leaveApproverList .employee-item'));
      employees.forEach(item => {
        const text = item.textContent.toLowerCase();
        const search = keyword.toLowerCase();
        item.style.display = text.includes(search) ? '' : 'none';
      });
    }
    
    /**
     * 🔍 협조자 목록 필터링
     */
    function filterLeaveCollaboratorList(keyword) {
      const employees = Array.from(document.querySelectorAll('#leaveCollaboratorList .employee-item'));
      employees.forEach(item => {
        const text = item.textContent.toLowerCase();
        const search = keyword.toLowerCase();
        item.style.display = text.includes(search) ? '' : 'none';
      });
    }
    
    /**
     * ✅ 결재자 토글 선택
     */
    function toggleLeaveApprover(empData) {
      const emp = typeof empData === 'string' ? JSON.parse(empData) : empData;
      const index = selectedApprovers.findIndex(a => a.empId === emp.empId);
      
      if (index === -1) {
        selectedApprovers.push(emp);
      } else {
        selectedApprovers.splice(index, 1);
      }
      
      // 선택 상태 UI 업데이트
      const employeeItem = document.querySelector(`.employee-item[data-employee='${JSON.stringify(emp)}']`);
      if (employeeItem) {
        employeeItem.classList.toggle('selected');
      }
    }
    
    /**
     * ✅ 협조자 토글 선택
     */
    function toggleLeaveCollaborator(empData) {
      const emp = typeof empData === 'string' ? JSON.parse(empData) : empData;
      const index = selectedCollaborators.findIndex(c => c.empId === emp.empId);
      
      if (index === -1) {
        selectedCollaborators.push(emp);
      } else {
        selectedCollaborators.splice(index, 1);
      }
      
      // 선택 상태 UI 업데이트
      const employeeItem = document.querySelector(`.employee-item[data-employee='${JSON.stringify(emp)}']`);
      if (employeeItem) {
        employeeItem.classList.toggle('selected');
      }
    }
    
    /**
     * ❌ 결재자 선택 모달 닫기
     */
    function closeLeaveApproverModal() {
      const modal = document.getElementById('approverModal');
      if (modal) {
        modal.remove();
      }
    }
    
    /**
     * ❌ 협조자 선택 모달 닫기
     */
    function closeCollaboratorModal() {
      const modal = document.getElementById('collaboratorModal');
      if (modal) {
        modal.remove();
      }
    }
    
    /**
     * ✅ 결재자 선택 완료
     */
    function confirmLeaveApproverSelection() {
      if (selectedApprovers.length === 0) {
        alert('결재자를 최소 1명 이상 선택해주세요.');
        return;
      }
      updateSelectedApprovers();
      closeLeaveApproverModal();
    }
    
    /**
     * ✅ 협조자 선택 완료
     */
    function confirmLeaveCollaboratorSelection() {
      updateSelectedCollaborators();
      closeCollaboratorModal();
    }
    
    /**
     * 📋 선택된 결재자 업데이트
     */
    function updateSelectedApprovers() {
      const container = document.getElementById('selectedApprovers');
      if (selectedApprovers.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">선택된 결재자가 없습니다.</p>';
      } else {
        container.innerHTML = selectedApprovers.map((approver, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
            <span>${index + 1}. ${approver.name} (${approver.position})</span>
            <button type="button" onclick="removeApprover(${index})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 0.25rem 0.5rem; cursor: pointer;">제거</button>
          </div>
        `).join('');
      }
    }
    
    /**
     * 📋 선택된 협조자 업데이트
     */
    function updateSelectedCollaborators() {
      const container = document.getElementById('selectedCollaborators');
      if (selectedCollaborators.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">선택된 협조자가 없습니다.</p>';
      } else {
        container.innerHTML = selectedCollaborators.map((collaborator, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
            <span>${collaborator.name} (${collaborator.position})</span>
            <button type="button" onclick="removeCollaborator(${index})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 0.25rem 0.5rem; cursor: pointer;">제거</button>
          </div>
        `).join('');
      }
    }
    
    /**
     * ❌ 결재자 제거
     */
    function removeApprover(index) {
      selectedApprovers.splice(index, 1);
      updateSelectedApprovers();
    }
    
    /**
     * ❌ 협조자 제거
     */
    function removeCollaborator(index) {
      selectedCollaborators.splice(index, 1);
      updateSelectedCollaborators();
    }
    
    /**
     * 📊 내 신청 현황 로드 (완전 재작성)
     */
    async function loadMyRequests() {
      console.log('🚀 loadMyRequests 함수 시작');
      
      const tableBody = document.getElementById('myRequestsTable');
      
      try {
        // 1. 기본 환경 확인
        console.log('🔍 환경 확인 중...');
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script 환경이 올바르지 않습니다.');
        }
        
        // 2. 사용자 정보 확인
        console.log('👤 사용자 정보 확인 중...');
        const empIdElement = document.getElementById('userEmpId');
        const userNameElement = document.getElementById('userName');
        
        if (!empIdElement || !empIdElement.textContent) {
          throw new Error('사용자 ID를 찾을 수 없습니다. 페이지를 새로고침해주세요.');
        }
        
        const empId = empIdElement.textContent.trim();
        const userName = userNameElement ? userNameElement.textContent.trim() : '사용자';
        
        console.log('👤 사용자 정보:', { empId, userName, type: typeof empId });
        
        if (!empId || empId === 'UNKNOWN' || empId === 'ERROR') {
          throw new Error(`유효하지 않은 사용자 ID: ${empId}`);
        }

        // 3. 로딩 상태 표시
        console.log('⏳ 로딩 상태 표시');
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; color: #666; padding: 2rem;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>📊 ${userName}님의 연차 신청 현황을 불러오는 중...</span>
              </div>
            </td>
          </tr>
        `;
        
        // 4. 서버 함수 직접 호출 (Promise 방식)
        console.log('📞 서버 함수 호출 시작 - getMyRequests:', empId);
        
        const myRequests = await new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error('서버 응답 시간 초과 (30초)'));
          }, 30000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              console.log('✅ getMyRequests 서버 응답 성공:', result);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              console.error('❌ getMyRequests 서버 응답 실패:', error);
              reject(new Error(error.toString()));
            })
            .getMyRequests(empId);
        });
        
        // 5. 응답 처리
        console.log('📋 응답 데이터 처리 시작:', { 
          type: typeof myRequests, 
          isArray: Array.isArray(myRequests),
          isNull: myRequests === null,
          length: myRequests ? myRequests.length : 'N/A'
        });
        
        // 오류 응답 처리
        if (myRequests && typeof myRequests === 'object' && myRequests.error) {
          console.error('🚨 서버 오류 응답:', myRequests);
          throw new Error(`서버 오류: ${myRequests.message || '알 수 없는 오류'}`);
        }
        
        // null 응답 처리
        if (myRequests === null || myRequests === undefined) {
          console.warn('⚠️ 서버에서 null/undefined 응답');
          throw new Error('서버에서 응답을 받지 못했습니다. 로그인 상태를 확인하거나 페이지를 새로고침해주세요.');
        }
        
        // 정상 데이터 처리
        if (Array.isArray(myRequests) && myRequests.length > 0) {
          console.log('✅ 신청 내역 발견:', myRequests.length, '건');
          console.log('📋 첫 번째 신청 데이터:', myRequests[0]);
          
          tableBody.innerHTML = myRequests.map((request, index) => {
            console.log(`📋 처리 중 ${index + 1}/${myRequests.length}:`, request);
            return `
              <tr>
                <td>${request.reqId || '-'}</td>
                <td>${formatDate(request.submitDate)}</td>
                <td>${request.leaveType || '-'}</td>
                <td>${formatDate(request.startDate)} ~ ${formatDate(request.endDate)}</td>
                <td>${request.days || 0}일</td>
                <td><span class="status-badge status-${getStatusClass(request.status)}">${request.status || '대기'}</span></td>
                <td>${request.reason || '-'}</td>
                <td><button onclick="showApprovalStatus('${request.reqId}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">상세보기</button></td>
              </tr>
            `;
          }).join('');
          
          console.log('✅ 내 신청 현황 로드 완료');
          showNotification(`연차 신청 현황 ${myRequests.length}건을 불러왔습니다.`, 'success');
          
        } else {
          console.log('ℹ️ 신청 내역 없음');
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; color: #666; padding: 2rem;">
                <div style="text-align: center;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                  <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">아직 신청한 연차가 없습니다</div>
                  <div style="color: #999; font-size: 0.9rem;">연차 신청 페이지에서 새로운 연차를 신청해보세요!</div>
                </div>
              </td>
            </tr>
          `;
        }
        
      } catch (error) {
        console.error('❌ 내 신청 현황 로드 전체 오류:', error);
        console.error('❌ 오류 스택:', error.stack);
        
        // 구체적인 오류 메시지
        let errorMessage = '알 수 없는 오류가 발생했습니다.';
        if (error.message) {
          errorMessage = error.message;
        } else if (typeof error === 'string') {
          errorMessage = error;
        }
        
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; color: #dc3545; padding: 2rem;">
              <div style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                <div style="font-size: 1.1rem; margin-bottom: 1rem; color: #dc3545;">
                  데이터를 불러올 수 없습니다
                </div>
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                  ${errorMessage}
                </div>
                <button onclick="loadMyRequests()" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                  🔄 다시 시도
                </button>
              </div>
            </td>
          </tr>
        `;
        
        // 사용자에게 알림
        showNotification(`내 신청 현황을 불러올 수 없습니다: ${errorMessage}`, 'error');
      }
    }
    
    /**
     * 📊 결재 현황 상세보기
     */
    function showApprovalStatus(reqId) {
      alert('결재 현황 상세보기 기능은 개발 중입니다. 신청ID: ' + reqId);
    }
    
    /**
     * ✅ 결재/협조 처리 목록 로드
     */
    async function loadApprovals() {
      try {
        // 결재 대기 목록
        const pendingApprovals = await callServerFunction('getPendingApprovals', currentUser.empId);
        const approvalsTable = document.getElementById('pendingApprovalsTable');
        
        if (pendingApprovals && pendingApprovals.length > 0) {
          approvalsTable.innerHTML = pendingApprovals.map(request => `
            <tr>
              <td>${request.reqId}</td>
              <td>${request.applicantName}</td>
              <td>${request.leaveType}</td>
              <td>${formatDate(request.startDate)} ~ ${formatDate(request.endDate)}</td>
              <td>${request.days}일</td>
              <td>${request.reason}</td>
              <td>
                <button onclick="processApproval('${request.reqId}', 'approve')" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">승인</button>
                <button onclick="processApproval('${request.reqId}', 'reject')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">반려</button>
              </td>
            </tr>
          `).join('');
        } else {
          approvalsTable.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">결재 대기 건이 없습니다.</td></tr>';
        }
        
        // 협조 대기 목록
        const pendingCollaborations = await callServerFunction('getPendingCollaborations', currentUser.empId);
        const collaborationsTable = document.getElementById('pendingCollaborationsTable');
        
        if (pendingCollaborations && pendingCollaborations.length > 0) {
          collaborationsTable.innerHTML = pendingCollaborations.map(request => `
            <tr>
              <td>${request.reqId}</td>
              <td>${request.applicantName}</td>
              <td>${request.leaveType}</td>
              <td>${formatDate(request.startDate)} ~ ${formatDate(request.endDate)}</td>
              <td>${request.days}일</td>
              <td>${request.reason}</td>
              <td>
                <button onclick="processCollaboration('${request.reqId}', 'approve')" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">협조</button>
                <button onclick="processCollaboration('${request.reqId}', 'reject')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">거부</button>
              </td>
            </tr>
          `).join('');
        } else {
          collaborationsTable.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">협조 대기 건이 없습니다.</td></tr>';
        }
        
      } catch (error) {
        console.error('결재/협조 목록 로드 오류:', error);
        document.getElementById('pendingApprovalsTable').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: #dc3545;">데이터를 불러올 수 없습니다.</td></tr>';
        document.getElementById('pendingCollaborationsTable').innerHTML = 
          '<tr><td colspan="7" style="text-align: center; color: #dc3545;">데이터를 불러올 수 없습니다.</td></tr>';
      }
    }
    
    /**
     * ✅ 결재 처리
     */
    async function processApproval(reqId, action) {
      const comment = prompt(action === 'approve' ? '승인 의견을 입력하세요 (선택사항):' : '반려 사유를 입력하세요:');
      
      if (action === 'reject' && !comment) {
        alert('반려 시에는 사유를 반드시 입력해주세요.');
        return;
      }
      
      try {
        showLoading(true);
        const result = await callServerFunction('processApproval', reqId, action, comment || '');
        
        if (result.success) {
          showNotification(action === 'approve' ? '승인 처리되었습니다.' : '반려 처리되었습니다.', 'success');
          loadApprovals(); // 목록 새로고침
          updateNotificationBadge(); // 알림 배지 업데이트
        } else {
          showNotification('처리 중 오류가 발생했습니다: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('결재 처리 오류:', error);
        showNotification('결재 처리 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    /**
     * 🤝 협조 처리
     */
    async function processCollaboration(reqId, action) {
      const comment = prompt(action === 'approve' ? '협조 의견을 입력하세요 (선택사항):' : '거부 사유를 입력하세요:');
      
      try {
        showLoading(true);
        const result = await callServerFunction('processCollaboration', reqId, action, comment || '');
        
        if (result.success) {
          showNotification(action === 'approve' ? '협조 처리되었습니다.' : '거부 처리되었습니다.', 'success');
          loadApprovals(); // 목록 새로고침
          updateNotificationBadge(); // 알림 배지 업데이트
        } else {
          showNotification('처리 중 오류가 발생했습니다: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('협조 처리 오류:', error);
        showNotification('협조 처리 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    /**
     * 👤 내 정보 로드
     */
    async function loadMyInfo() {
      try {
        // 빠른 부서 정보 로드를 위해 최적화된 함수 사용
        const myLeaveInfo = await callServerFunction('getMyLeaveInfoFast', currentUser.empId);
        const container = document.getElementById('myLeaveInfo');
        
        if (myLeaveInfo) {
          // 내 정보 페이지의 부서명 업데이트
          const deptNameInput = document.getElementById('myInfoDeptName');
          if (deptNameInput) {
            // 로딩 상태 제거
            deptNameInput.classList.remove('loading-input');
            deptNameInput.value = myLeaveInfo.deptName || '부서 미지정';
          }
          
          // 대시보드 헤더의 부서 배지 업데이트
          const deptBadge = document.getElementById('dashboardDeptBadge');
          if (deptBadge) {
            // 로딩 상태 제거
            deptBadge.classList.remove('loading-badge');
            deptBadge.innerHTML = myLeaveInfo.deptName || '부서 미지정';
          }
          
          // 관리자인 경우 특별 처리
          if (myLeaveInfo.isAdmin) {
            container.innerHTML = `
              <div class="dashboard-card admin-info">
                <div class="card-icon">🔐</div>
                <div class="card-value">관리자</div>
                <div class="card-label">시스템 관리자</div>
              </div>
              <div class="dashboard-card admin-info">
                <div class="card-icon">⚙️</div>
                <div class="card-value">모든 권한</div>
                <div class="card-label">관리 권한</div>
              </div>
              <div class="dashboard-card admin-info">
                <div class="card-icon">📊</div>
                <div class="card-value">무제한</div>
                <div class="card-label">시스템 접근</div>
              </div>
              <div class="dashboard-card admin-info">
                <div class="card-icon">ℹ️</div>
                <div class="card-value">-</div>
                <div class="card-label">연차 정보 없음</div>
              </div>
            `;
          } else if (myLeaveInfo.error) {
            // 오류가 있는 경우
            container.innerHTML = `
              <div class="dashboard-card error">
                <div class="card-icon">⚠️</div>
                <div class="card-value">오류</div>
                <div class="card-label">${myLeaveInfo.error}</div>
              </div>
            `;
          } else {
            // 일반 직원인 경우 기존 로직
            container.innerHTML = `
              <div class="dashboard-card">
                <div class="card-icon">👤</div>
                <div class="card-value">${myLeaveInfo.empName || currentUser.name}</div>
                <div class="card-label">이름</div>
              </div>
              <div class="dashboard-card">
                <div class="card-icon">🏢</div>
                <div class="card-value">${myLeaveInfo.deptName || '부서 미지정'}</div>
                <div class="card-label">소속 부서</div>
              </div>
              <div class="dashboard-card">
                <div class="card-icon">📅</div>
                <div class="card-value">${myLeaveInfo.totalLeaves || 15}</div>
                <div class="card-label">총 연차 일수</div>
              </div>
              <div class="dashboard-card">
                <div class="card-icon">✅</div>
                <div class="card-value">${myLeaveInfo.usedLeaves || 0}</div>
                <div class="card-label">사용한 연차</div>
              </div>
              <div class="dashboard-card">
                <div class="card-icon">📊</div>
                <div class="card-value">${myLeaveInfo.remainingLeaves || 15}</div>
                <div class="card-label">남은 연차</div>
              </div>
              <div class="dashboard-card">
                <div class="card-icon">📈</div>
                <div class="card-value">${myLeaveInfo.thisYearUsed || 0}</div>
                <div class="card-label">올해 사용</div>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('내 정보 로드 오류:', error);
        document.getElementById('myLeaveInfo').innerHTML = 
          '<p style="text-align: center; color: #dc3545;">TypeError: google.script.run.withSuccessHandler(...).withFailureHandler(...)[functionName] is not a function<br/>서버 함수를 찾을 수 없습니다. 페이지를 새로고침해주세요.</p>';
      }
    }
    
    /**
     * 🔑 비밀번호 변경
     */
    async function changePassword(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        alert('새 비밀번호가 일치하지 않습니다.');
        return;
      }
      
      if (newPassword.length < 8) {
        alert('새 비밀번호는 8자 이상이어야 합니다.');
        return;
      }
      
      try {
        showLoading(true);
        const result = await callServerFunction('changePassword', currentPassword, newPassword);
        
        if (result && result.success) {
          showNotification('비밀번호가 성공적으로 변경되었습니다.', 'success');
          document.getElementById('changePasswordForm').reset();
        } else {
          const errorMessage = result && result.message ? result.message : '알 수 없는 오류가 발생했습니다.';
          showNotification('비밀번호 변경 실패: ' + errorMessage, 'error');
        }
      } catch (error) {
        console.error('비밀번호 변경 오류:', error);
        showNotification('비밀번호 변경 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    /**
     * 🔄 알림 배지 업데이트
     */
    async function updateNotificationBadge() {
      try {
        const notificationCount = await callServerFunction('getNotificationCount', currentUser.empId);
        const badge = document.getElementById('notificationBadge');
        
        if (badge) {
          if (notificationCount > 0) {
            badge.textContent = notificationCount;
            badge.style.display = 'block';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('알림 배지 업데이트 오류:', error);
      }
    }
    
    /**
     * 🚪 로그아웃
     */
    async function logout() {
      if (confirm('정말 로그아웃하시겠습니까?')) {
        try {
          // 로딩 표시
          showLoading(true);
          
          const result = await callServerFunction('doLogout');
          
          if (result && result.success !== false) {
            // 성공 메시지 표시
            showNotification('로그아웃되었습니다. 로그인 페이지로 이동합니다.', 'success');
            
            // 서버에서 로그인 페이지 HTML을 직접 가져와서 교체
            try {
              const loginPageResult = await callServerFunction('getLoginPageAfterLogout');
              
              if (loginPageResult && loginPageResult.success && loginPageResult.html) {
                // 현재 페이지 전체를 로그인 페이지 HTML로 교체
                document.open();
                document.write(loginPageResult.html);
                document.close();
              } else {
                throw new Error('로그인 페이지 HTML 가져오기 실패');
              }
            } catch (htmlError) {
              // HTML 교체 실패 시 URL 리다이렉트로 폴백
              const baseUrl = window.location.href.split('?')[0];
              window.location.replace(baseUrl + '?logout=true&t=' + new Date().getTime());
            }
            
          } else {
            throw new Error(result.message || '로그아웃 처리 실패');
          }
          
        } catch (error) {
          showLoading(false);
          
          showNotification('로그아웃 중 오류가 발생했습니다. 페이지를 새로고침합니다.', 'error');
          
          // 오류가 발생해도 강제로 페이지 새로고침 (세션 삭제 시도)
          setTimeout(() => {
            const baseUrl = window.location.href.split('?')[0];
            window.location.replace(baseUrl + '?logout=true&t=' + new Date().getTime());
          }, 1500);
        }
      }
    }
    
    /**
     * 📱 외부 클릭 시 드롭다운 닫기
     */
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.user-menu')) {
        hideUserMenu();
      }
    });
    
    // 웹앱 공통 함수들
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification ' + type;
      notification.textContent = message;
      notification.style.cssText = 
        'position: fixed;' +
        'top: 20px;' +
        'right: 20px;' +
        'padding: 15px 20px;' +
        'border-radius: 5px;' +
        'color: white;' +
        'font-weight: bold;' +
        'z-index: 1000;' +
        'animation: slideIn 0.3s ease-out;' +
        (type === 'success' ? 'background-color: #4CAF50;' : '') +
        (type === 'error' ? 'background-color: #f44336;' : '') +
        (type === 'info' ? 'background-color: #2196F3;' : '');
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    function showLoading(show = true) {
      let loader = document.getElementById('loading');
      if (show) {
        if (!loader) {
          loader = document.createElement('div');
          loader.id = 'loading';
          loader.innerHTML = '<div class="spinner"></div><p>처리 중...</p>';
          loader.style.cssText = 
            'position: fixed;' +
            'top: 0;' +
            'left: 0;' +
            'width: 100%;' +
            'height: 100%;' +
            'background-color: rgba(0,0,0,0.5);' +
            'display: flex;' +
            'flex-direction: column;' +
            'justify-content: center;' +
            'align-items: center;' +
            'z-index: 2000;' +
            'color: white;';
          document.body.appendChild(loader);
        }
        loader.style.display = 'flex';
      } else {
        if (loader) {
          loader.style.display = 'none';
        }
      }
    }

    function calculateDays(startDate, endDate, leaveType) {
      if (!startDate || !endDate) return 0;
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      
      if (leaveType === '반차') {
        return 0.5;
      } else if (leaveType === '연차') {
        return diffDays;
      } else {
        return diffDays; // 특별휴가는 실제 일수
      }
    }

    /**
     * 🔔 알림 확인 함수
     */
    async function checkNotifications() {
      try {
        const notifications = await callServerFunction('getNotifications');
        updateNotificationBadge();
        return notifications;
      } catch (error) {
        console.error('알림 확인 오류:', error);
        return [];
      }
    }
    
    // 60초마다 알림 확인 (네트워크 요청 빈도 줄임)
    setInterval(checkNotifications, 60000);

    // =====================================
    // 📅 근무표 관리 함수들
    // =====================================

    /**
     * 📅 근무표 페이지 로드
     */
    async function loadWorkSchedulePage() {
      try {
        console.log('📅 근무표 페이지 로드 시작...');
        
        // 사용자 부서 정보 로드 (비동기 처리)
        loadUserDepartmentInfo().then(() => {
          console.log('✅ 사용자 부서 정보 로드 완료');
        }).catch(error => {
          console.error('❌ 사용자 부서 정보 로드 실패:', error);
        });
        
        // 현재 월로 기본 설정
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        document.getElementById('scheduleMonth').value = currentMonth;
        
        console.log('✅ 근무표 페이지 로드 완료');
        
      } catch (error) {
        console.error('❌ 근무표 페이지 로드 오류:', error);
        showNotification('근무표 페이지를 불러올 수 없습니다.', 'error');
      }
    }

    /**
     * 👤 현재 사용자 ID 가져오기
     */
    function getCurrentUserId() {
      // 세션에서 사용자 ID 가져오기
      const session = getValidSession();
      if (session) {
        return session.userType === 'admin' ? session.adminId : session.empId;
      }
      return null;
    }

    /**
     * 👤 현재 사용자 부서 ID 가져오기
     */
    function getCurrentUserDeptId() {
      // 세션에서 부서 ID 가져오기 (임시)
      const session = getValidSession();
      if (session && session.userType === 'employee') {
        return session.deptId || null;
      }
      return null;
    }

    /**
     * 👤 사용자 부서 정보 로드
     */
    async function loadUserDepartmentInfo() {
      try {
        // 현재 로그인한 사용자 정보 가져오기
        const userInfo = await callServerFunction('getMyLeaveInfoFast', getCurrentUserId());
        
        if (userInfo && userInfo.deptName) {
          // 부서 정보 표시
          document.getElementById('userDeptName').textContent = userInfo.deptName;
          
          // 사용자 부서 ID 저장 (근무표 생성 시 사용)
          window.currentUserDeptId = userInfo.deptId || getCurrentUserDeptId();
          
          console.log('✅ 사용자 부서 정보 로드 완료:', userInfo.deptName);
        } else {
          document.getElementById('userDeptName').textContent = '부서 정보 없음';
          console.warn('⚠️ 사용자 부서 정보를 찾을 수 없습니다.');
        }
        
      } catch (error) {
        console.error('❌ 사용자 부서 정보 로드 오류:', error);
        document.getElementById('userDeptName').textContent = '부서 정보 로드 실패';
        showNotification('부서 정보를 불러올 수 없습니다.', 'error');
      }
    }

    /**
     * 📊 근무표 데이터 로드
     */
    async function loadWorkScheduleData() {
      const scheduleMonth = document.getElementById('scheduleMonth').value;
      const userDeptId = window.currentUserDeptId;
      
      if (!userDeptId || !scheduleMonth) {
        // 사용자 부서 정보가 없거나 월이 선택되지 않은 경우
        showEmptyScheduleState();
        return;
      }
      
      try {
        console.log('📊 근무표 로드 중...', userDeptId, scheduleMonth);
        
        // 로딩 상태 표시
        showScheduleLoading();
        
        const [year, month] = scheduleMonth.split('-');
        const scheduleData = await callServerFunction('getWorkScheduleData', userDeptId, parseInt(year), parseInt(month));
        
        if (scheduleData) {
          displayWorkSchedule(scheduleData);
        } else {
          showScheduleNotFound(userDeptId, year, month);
        }
        
      } catch (error) {
        console.error('❌ 근무표 로드 오류:', error);
        showScheduleError();
      }
    }

    /**
     * 📊 근무표 데이터 로드 (기존 함수명 유지)
     */
    async function loadWorkSchedule() {
      const scheduleMonth = document.getElementById('scheduleMonth').value;
      const userDeptId = window.currentUserDeptId;
      
      if (!userDeptId || !scheduleMonth) {
        // 사용자 부서 정보가 없거나 월이 선택되지 않은 경우
        showEmptyScheduleState();
        return;
      }
      
      try {
        console.log('📊 근무표 로드 중...', userDeptId, scheduleMonth);
        
        // 로딩 상태 표시
        showScheduleLoading();
        
        const [year, month] = scheduleMonth.split('-');
        const scheduleData = await callServerFunction('getWorkScheduleData', userDeptId, parseInt(year), parseInt(month));
        
        if (scheduleData) {
          displayWorkSchedule(scheduleData);
        } else {
          showScheduleNotFound(userDeptId, year, month);
        }
        
      } catch (error) {
        console.error('❌ 근무표 로드 오류:', error);
        showScheduleError();
      }
    }

    /**
     * 📋 근무표 시트 생성
     */
    async function createWorkScheduleSheet() {
      const scheduleMonth = document.getElementById('scheduleMonth').value;
      const userDeptId = window.currentUserDeptId;
      
      if (!userDeptId || !scheduleMonth) {
        showNotification('부서 정보가 없거나 월을 선택해주세요.', 'warning');
        return;
      }
      
      const confirmed = confirm('새로운 근무표 시트를 생성하시겠습니까?\n\n기존 데이터가 있다면 덮어쓰여질 수 있습니다.');
      if (!confirmed) return;
      
      try {
        showLoading(true);
        
        const [year, month] = scheduleMonth.split('-');
        const result = await callServerFunction('createWorkScheduleSheet', userDeptId, parseInt(year), parseInt(month));
        
        if (result.success) {
          showNotification('근무표 시트가 생성되었습니다.', 'success');
          // 생성 후 자동으로 로드
          await loadWorkSchedule();
        } else {
          showNotification('근무표 생성 실패: ' + result.error, 'error');
        }
        
      } catch (error) {
        console.error('❌ 근무표 생성 오류:', error);
        showNotification('근무표 생성 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * 📅 근무표 표시
     */
    function displayWorkSchedule(scheduleData) {
      const container = document.getElementById('workScheduleContainer');
      
      if (!scheduleData || !scheduleData.employeeData || scheduleData.employeeData.length === 0) {
        showScheduleNotFound();
        return;
      }
      
      // 테이블 HTML 생성
      let tableHTML = `
        <table class="work-schedule-table">
          <thead>
            <tr class="schedule-title">
              <td colspan="${scheduleData.columnHeaders.length}">${scheduleData.title || '근무표'}</td>
            </tr>
            <tr class="schedule-header">
              ${scheduleData.columnHeaders.map(header => `<th>${header}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
      `;
      
      // 직원 데이터 행 추가
      scheduleData.employeeData.forEach(row => {
        tableHTML += '<tr>';
        row.forEach((cell, index) => {
          const cellClass = getCellClass(cell, index, scheduleData);
          tableHTML += `<td class="${cellClass}">${cell || ''}</td>`;
        });
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody></table>';
      
      container.innerHTML = tableHTML;
    }

    /**
     * 📋 빈 상태 표시
     */
    function showEmptyScheduleState() {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">📅</div>
          <h3>근무표가 없습니다</h3>
          <p>선택한 월의 근무표가 생성되지 않았습니다.</p>
          <button onclick="createWorkScheduleSheet()" class="btn btn-primary">
            📋 근무표 생성
          </button>
        </div>
      `;
    }

    /**
     * 🔍 근무표 없음 상태 표시
     */
    function showScheduleNotFound(deptId, year, month) {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">🔍</div>
          <h3>근무표를 찾을 수 없습니다</h3>
          <p>${year}년 ${month}월의 근무표가 존재하지 않습니다.</p>
          <button onclick="createWorkScheduleSheet()" class="btn btn-primary">
            📋 근무표 생성
          </button>
        </div>
      `;
    }

    /**
     * ⏳ 로딩 상태 표시
     */
    function showScheduleLoading() {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>근무표를 불러오는 중...</p>
        </div>
      `;
    }

    /**
     * ❌ 오류 상태 표시
     */
    function showScheduleError() {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="error-state">
          <div class="error-icon">❌</div>
          <h3>오류가 발생했습니다</h3>
          <p>근무표를 불러오는 중 오류가 발생했습니다.</p>
          <button onclick="loadWorkScheduleData()" class="btn btn-secondary">
            🔄 다시 시도
          </button>
        </div>
      `;
    }

    /**
     * 🎨 셀 클래스 결정
     */
    function getCellClass(cellValue, columnIndex, scheduleData) {
      // 기본 클래스
      let classes = [];
      
      // 직원 정보 열 (사번, 이름 등)
      if (columnIndex < 4) {
        classes.push('employee-info');
      }
      
      // 연차 표시
      if (cellValue === 'Y') {
        classes.push('leave-full');
      } else if (cellValue === 'Y/2') {
        classes.push('leave-half');
      } else if (cellValue === 'D') {
        classes.push('work-day');
      } else if (cellValue === 'OFF') {
        classes.push('holiday');
      }
      
      // 주말 색상 (추후 구현)
      // TODO: 날짜 정보를 통해 주말 판단
      
      return classes.join(' ');
    }

    /**
     * 🔄 로딩 상태 표시
     */
    function showScheduleLoading() {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="schedule-loading">
          <div class="spinner"></div>
          <h3>근무표를 불러오는 중입니다...</h3>
          <p>잠시만 기다려주세요.</p>
        </div>
      `;
    }

    /**
     * 📭 빈 상태 표시
     */
    function showEmptyScheduleState() {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">📅</div>
          <h3>근무표를 확인해주세요</h3>
          <p>조회할 월을 선택하면 근무표가 표시됩니다.</p>
        </div>
      `;
    }

    /**
     * 🚫 근무표 없음 상태
     */
    function showScheduleNotFound(deptId, year, month) {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">📋</div>
          <h3>근무표가 없습니다</h3>
          <p>${year}년 ${month}월 근무표가 생성되지 않았습니다.</p>
          <button class="btn btn-primary" onclick="createWorkScheduleSheet()">
            <span>📋</span> 근무표 생성하기
          </button>
        </div>
      `;
    }

    /**
     * ❌ 오류 상태 표시
     */
    function showScheduleError() {
      const container = document.getElementById('workScheduleContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">⚠️</div>
          <h3>오류가 발생했습니다</h3>
          <p>근무표를 불러오는 중 문제가 발생했습니다.</p>
          <button class="btn btn-secondary" onclick="loadWorkSchedule()">
            <span>🔄</span> 다시 시도
          </button>
        </div>
      `;
    }

    // =====================================
    // 🔧 관리자 기능 함수들
    // =====================================

    /**
     * 🔍 디버깅: 시트 데이터 확인 (임시 함수)
     */
    async function debugEmployeeData() {
      try {
        const result = await callServerFunction('debugSheetData');
        console.log('시트 디버깅 결과:', result);
        alert('시트 디버깅 결과를 콘솔에서 확인하세요.');
        return result;
      } catch (error) {
        console.error('디버깅 오류:', error);
        alert('디버깅 오류: ' + error.message);
      }
    }

    /**
     * 👥 직원 관리 페이지 로드
     */
    async function loadEmployeeManagement() {
      try {
        console.log('🔍 직원 관리 페이지 로드 시작');
        
        console.log('📞 getEmployeesForWeb 서버 함수 호출 중...');
        const employees = await callServerFunction('getEmployeesForWeb');
        console.log('✅ getEmployeesForWeb 결과:', employees);
        
        console.log('📞 getAllDepartments 서버 함수 호출 중...');
        const departments = await callServerFunction('getAllDepartments');
        console.log('✅ getAllDepartments 결과:', departments);
        
        // 전역 직원 목록 저장
        allEmployees = employees || [];
        
        // 부서 선택 옵션 업데이트
        const deptSelect = document.getElementById('empDept');
        if (deptSelect) {
          deptSelect.innerHTML = '<option value="">선택하세요</option>';
          departments.forEach(dept => {
            deptSelect.innerHTML += `<option value="${dept.deptId}">${dept.deptName}</option>`;
          });
        }
        
        // 직원 목록 표시
        console.log('📋 직원 목록 표시 중...');
        displayEmployeeList(allEmployees);
        console.log('✅ 직원 관리 페이지 로드 완료');
        
      } catch (error) {
        console.error('❌ 직원 관리 페이지 로드 오류:', error);
        showNotification('직원 목록을 불러올 수 없습니다.', 'error');
      }
    }

    /**
     * 👥 직원 목록 표시 (페이지네이션 적용)
     */
    function displayEmployeeList(employees) {
      console.log('📋 displayEmployeeList 함수 호출됨');
      console.log('📊 전달받은 직원 데이터:', employees);
      console.log('📈 직원 수:', employees ? employees.length : 'undefined');
      
      const tableBody = document.getElementById('employeeListTable');
      console.log('🎯 테이블 요소:', tableBody);
      
      if (!employees || employees.length === 0) {
        console.log('⚠️ 직원 데이터가 없음 - 빈 메시지 표시');
        tableBody.innerHTML = '<tr><td colspan="6" class="empty-message">📋 등록된 직원이 없습니다.</td></tr>';
        hidePagination();
        return;
      }
      
      // 페이지네이션 적용
      filteredEmployees = employees;
      initializePagination();
      
      // 현재 페이지의 직원들만 표시
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentPageEmployees = filteredEmployees.slice(startIndex, endIndex);
      
      console.log('✅ 직원 목록 테이블 생성 중...');
      const tableHTML = currentPageEmployees.map(emp => `
        <tr>
          <td class="col-empid">${emp.empId}</td>
          <td class="col-name">${emp.name}</td>
          <td class="col-email">${emp.email}</td>
          <td class="col-dept">${emp.deptName || '미지정'}</td>
          <td class="col-position">${emp.position || '-'}</td>
          <td class="col-actions">
            <button class="btn btn-secondary" onclick="editEmployee('${emp.empId}')">
              <span class="btn-icon">✏️</span>
              <span class="btn-text">수정</span>
            </button>
            <button class="btn btn-danger" onclick="deleteEmployee('${emp.empId}')">
              <span class="btn-icon">🗑️</span>
              <span class="btn-text">삭제</span>
            </button>
          </td>
        </tr>
      `).join('');
      
      console.log('📝 생성된 HTML:', tableHTML);
      tableBody.innerHTML = tableHTML;
      updatePaginationUI();
      console.log('✅ 직원 목록 표시 완료');
    }
    
    /**
     * 📄 페이지네이션 초기화
     */
    function initializePagination() {
      const totalItems = filteredEmployees.length;
      totalPages = Math.ceil(totalItems / itemsPerPage);
      
      // 현재 페이지가 총 페이지 수를 초과하면 1페이지로 이동
      if (currentPage > totalPages) {
        currentPage = 1;
      }
      
      // 페이지네이션 UI 표시/숨김
      const paginationContainer = document.getElementById('employeePagination');
      if (totalPages > 1) {
        paginationContainer.style.display = 'flex';
      } else {
        paginationContainer.style.display = 'none';
      }
      
      console.log('📄 페이지네이션 초기화: 총 ' + totalItems + '개 항목, ' + totalPages + '페이지');
    }
    
    /**
     * 🙈 페이지네이션 숨김
     */
    function hidePagination() {
      const paginationContainer = document.getElementById('employeePagination');
      paginationContainer.style.display = 'none';
    }
    
    /**
     * 🔄 페이지네이션 UI 업데이트
     */
    function updatePaginationUI() {
      const totalItems = filteredEmployees.length;
      const startItem = (currentPage - 1) * itemsPerPage + 1;
      const endItem = Math.min(currentPage * itemsPerPage, totalItems);
      
      // 정보 텍스트 업데이트
      document.getElementById('paginationInfo').textContent = 
        `${startItem}-${endItem} of ${totalItems} 직원`;
      
      // 페이지 번호 버튼들 생성
      generatePageNumbers();
      
      // 이전/다음 버튼 상태 업데이트
      document.getElementById('firstPageBtn').disabled = currentPage === 1;
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
      document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
    }
    
    /**
     * 🔢 페이지 번호 버튼 생성
     */
    function generatePageNumbers() {
      const pageNumbersContainer = document.getElementById('pageNumbers');
      pageNumbersContainer.innerHTML = '';
      
      // 페이지 번호 표시 로직 (최대 7개 버튼)
      let startPage = Math.max(1, currentPage - 3);
      let endPage = Math.min(totalPages, currentPage + 3);
      
      // 시작 페이지 조정
      if (endPage - startPage < 6) {
        if (startPage === 1) {
          endPage = Math.min(totalPages, startPage + 6);
        } else {
          startPage = Math.max(1, endPage - 6);
        }
      }
      
      // 페이지 번호 버튼 생성
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
        pageBtn.textContent = i;
        pageBtn.onclick = () => goToPage(i);
        pageNumbersContainer.appendChild(pageBtn);
      }
    }
    
    /**
     * 📄 특정 페이지로 이동
     */
    function goToPage(pageNumber) {
      if (pageNumber < 1 || pageNumber > totalPages) {
        return;
      }
      
      currentPage = pageNumber;
      displayEmployeeList(filteredEmployees);
      
      console.log('📄 페이지 이동: ' + pageNumber + '페이지');
    }
    
    /**
     * 📊 페이지당 항목 수 변경
     */
    function changeItemsPerPage() {
      const select = document.getElementById('itemsPerPage');
      itemsPerPage = parseInt(select.value);
      currentPage = 1; // 첫 페이지로 이동
      
      displayEmployeeList(filteredEmployees);
      
      console.log('📊 페이지당 항목 수 변경: ' + itemsPerPage + '개');
    }

    /**
     * 🔍 직원 검색 기능 (페이지네이션 연동)
     */
    function searchEmployees() {
      const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        // 검색어가 없으면 전체 목록 표시
        currentPage = 1; // 첫 페이지로 이동
        displayEmployeeList(allEmployees);
        return;
      }
      
      // 검색어에 맞는 직원 필터링
      const searchFilteredEmployees = allEmployees.filter(emp => {
        const empId = emp.empId.toLowerCase();
        const name = emp.name.toLowerCase();
        const email = emp.email.toLowerCase();
        const deptName = (emp.deptName || '').toLowerCase();
        const position = (emp.position || '').toLowerCase();
        
        return empId.includes(searchTerm) || 
               name.includes(searchTerm) || 
               email.includes(searchTerm) || 
               deptName.includes(searchTerm) || 
               position.includes(searchTerm);
      });
      
      // 검색 결과 표시
      currentPage = 1; // 검색 시 첫 페이지로 이동
      displayEmployeeList(searchFilteredEmployees);
      
      // 검색 결과 메시지 표시
      if (searchFilteredEmployees.length === 0) {
        const tableBody = document.getElementById('employeeListTable');
        tableBody.innerHTML = '<tr><td colspan="6" class="search-empty-message">🔍 검색 결과가 없습니다. 다른 키워드로 검색해보세요.</td></tr>';
        hidePagination();
      }
      
      console.log('🔍 검색 완료: "' + searchTerm + '" -> ' + searchFilteredEmployees.length + '개 결과');
    }

    /**
     * 🔄 직원 검색 초기화
     */
    function clearEmployeeSearch() {
      document.getElementById('employeeSearchInput').value = '';
      currentPage = 1; // 첫 페이지로 이동
      displayEmployeeList(allEmployees); // 전체 목록 표시
      console.log('🔄 검색 초기화 완료');
    }

    /**
     * 👥 직원 추가
     */
    async function addEmployee(event) {
      event.preventDefault();
      
      const formData = {
        name: document.getElementById('empName').value,
        email: document.getElementById('empEmail').value,
        phone: document.getElementById('empPhone').value,
        deptId: document.getElementById('empDept').value,
        position: document.getElementById('empPosition').value
      };
      
      try {
        showLoading(true);
        const result = await callServerFunction('addEmployee', formData);
        
        if (result.success) {
          // 상세한 성공 메시지 표시
          const successMessage = `
            ✅ 직원이 성공적으로 추가되었습니다!
            
            📋 생성된 사번: ${result.empId}
            📧 이메일: ${result.loginInfo.email}
            🔑 초기 비밀번호: ${result.loginInfo.password}
            
            ⚠️ 해당 직원에게 로그인 정보를 안전하게 전달해주세요.
            첫 로그인 시 비밀번호 변경이 필요합니다.
          `;
          
          alert(successMessage);
          showNotification('직원 추가 완료 (사번: ' + result.empId + ')', 'success');
          document.getElementById('addEmployeeForm').reset();
          
          // 직원 목록 새로고침 (최신 직원이 맨 위에 표시됨)
          await refreshEmployeeList();
          
          // 검색창 초기화
          clearEmployeeSearch();
          
        } else {
          showNotification('직원 추가 실패: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('직원 추가 오류:', error);
        showNotification('직원 추가 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * 🔄 직원 목록 새로고침 (페이지네이션 연동)
     */
    async function refreshEmployeeList() {
      try {
        console.log('🔄 직원 목록 새로고침 중...');
        const employees = await callServerFunction('getEmployeesForWeb');
        
        // 전역 변수 업데이트
        allEmployees = employees || [];
        
        // 현재 검색 상태 확인
        const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase().trim();
        
        if (searchTerm) {
          // 검색 중이면 다시 검색 실행
          searchEmployees();
        } else {
          // 검색 중이 아니면 전체 목록 표시 (현재 페이지 유지)
          displayEmployeeList(allEmployees);
        }
        
        console.log('✅ 직원 목록 새로고침 완료 (총 ' + allEmployees.length + '명)');
      } catch (error) {
        console.error('❌ 직원 목록 새로고침 오류:', error);
        showNotification('직원 목록 새로고침 중 오류가 발생했습니다.', 'error');
      }
    }

    /**
     * 🏢 부서 관리 페이지 로드
     */
    async function loadDepartmentManagement() {
      try {
        // 직원 수가 필요한 경우에만 getAllDepartments 사용, 
        // 일반적인 목록 조회는 빠른 함수 사용 후 필요시 직원 수만 별도 조회
        const departments = await callServerFunction('getAllDepartments');
        displayDepartmentList(departments);
      } catch (error) {
        console.error('부서 관리 페이지 로드 오류:', error);
        showNotification('부서 목록을 불러올 수 없습니다.', 'error');
      }
    }
    
    // ===========================================
    // 🎯 부서 관리 드래그 앤 드롭 보드 관련 함수들
    // ===========================================
    
    /**
     * 🔄 부서 뷰 전환 (목록 뷰 ↔ 보드 뷰)
     */
    function switchDepartmentView(viewType) {
      console.log('🔄 부서 뷰 전환:', viewType);
      
      // 탭 활성화 상태 변경
      document.querySelectorAll('#departmentManagementPage .view-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // 선택된 탭 활성화
      const activeTab = viewType === 'list' ? 'deptListViewTab' : 'deptBoardViewTab';
      document.getElementById(activeTab).classList.add('active');
      
      // 뷰 전환
      document.querySelectorAll('.department-view').forEach(view => {
        view.classList.remove('active');
      });
      
      const targetView = viewType === 'list' ? 'departmentListView' : 'departmentBoardView';
      document.getElementById(targetView).classList.add('active');
      
      // 보드 뷰로 전환 시 데이터 로드
      if (viewType === 'board') {
        loadDepartmentBoard();
      }
    }
    
    /**
     * 🎯 부서 보드 데이터 로드
     */
    async function loadDepartmentBoard() {
      try {
        console.log('🎯 부서 보드 로드 시작...');
        
        // 로딩 표시
        const kanbanBoard = document.getElementById('deptKanbanBoard');
        kanbanBoard.innerHTML = `
          <div class="board-loading">
            <div class="spinner"></div>
            <p>부서별 직원 보드를 불러오는 중입니다...</p>
          </div>
        `;
        
        // 직원 및 부서 데이터 로드 (부서는 빠른 조회 사용)
        const [employees, departments] = await Promise.all([
          callServerFunction('getEmployeesForWeb'),
          callServerFunction('getDepartmentsQuick')
        ]);
        
        console.log('📊 로드된 직원 수:', employees ? employees.length : 0);
        console.log('🏢 로드된 부서 수:', departments ? departments.length : 0);
        
        // 부서별 직원 그룹핑
        const employeesByDept = groupEmployeesByDepartmentForBoard(employees, departments);
        
        // 보드 통계 업데이트
        updateDepartmentBoardStats(employees, departments);
        
        // 칸반 보드 생성
        createDepartmentKanbanBoard(employeesByDept);
        
        console.log('✅ 부서 보드 로드 완료');
        
      } catch (error) {
        console.error('❌ 부서 보드 로드 오류:', error);
        document.getElementById('deptKanbanBoard').innerHTML = `
          <div class="board-loading">
            <p style="color: #dc3545;">⚠️ 보드를 불러올 수 없습니다. 페이지를 새로고침해주세요.</p>
          </div>
        `;
            }
    }
    
    /**
     * 📊 부서별 직원 그룹핑 (부서 보드용)
     */
    function groupEmployeesByDepartmentForBoard(employees, departments) {
      const employeesByDept = {};
      
      // 모든 부서 초기화
      departments.forEach(dept => {
        employeesByDept[dept.deptId] = {
          department: dept,
          employees: []
        };
      });
      
      // 직원들을 부서별로 분류
      employees.forEach(emp => {
        const deptId = emp.deptId || 'unknown';
        if (employeesByDept[deptId]) {
          employeesByDept[deptId].employees.push(emp);
        } else {
          // 미지정 부서 처리
          if (!employeesByDept['unknown']) {
            employeesByDept['unknown'] = {
              department: { deptId: 'unknown', deptName: '미지정' },
              employees: []
            };
          }
          employeesByDept['unknown'].employees.push(emp);
        }
      });
      
      return employeesByDept;
    }
    
    /**
     * 📈 부서 보드 통계 업데이트
     */
    function updateDepartmentBoardStats(employees, departments) {
      const totalEmployees = employees ? employees.length : 0;
      const totalDepartments = departments ? departments.length : 0;
      
      document.getElementById('deptBoardTotalEmployees').innerHTML = 
        `총 <strong>${totalEmployees}</strong>명`;
      document.getElementById('deptBoardTotalDepartments').innerHTML = 
        `<strong>${totalDepartments}</strong>개 부서`;
    }
    
    /**
     * 🎯 부서 칸반 보드 생성
     */
    function createDepartmentKanbanBoard(employeesByDept) {
      const kanbanBoard = document.getElementById('deptKanbanBoard');
      
      // 기존 내용 제거
      kanbanBoard.innerHTML = '';
      
      // 부서 수에 따른 그리드 레이아웃 클래스 적용
      const departmentCount = Object.keys(employeesByDept).length;
      
      // 기존 클래스 제거
      kanbanBoard.className = 'kanban-board';
      
      // 부서 수에 따른 클래스 추가
      if (departmentCount === 1) {
        kanbanBoard.classList.add('departments-1');
      } else if (departmentCount === 2) {
        kanbanBoard.classList.add('departments-2');
      } else if (departmentCount === 3) {
        kanbanBoard.classList.add('departments-3');
      } else if (departmentCount === 4) {
        kanbanBoard.classList.add('departments-4');
      } else if (departmentCount === 5) {
        kanbanBoard.classList.add('departments-5');
      } else if (departmentCount === 6) {
        kanbanBoard.classList.add('departments-6');
      } else if (departmentCount === 7) {
        kanbanBoard.classList.add('departments-7');
      } else if (departmentCount === 8) {
        kanbanBoard.classList.add('departments-8');
      } else {
        kanbanBoard.classList.add('departments-many');
      }
      
      // 부서별 칼럼 생성
      Object.values(employeesByDept).forEach(deptData => {
        const column = createDepartmentBoardColumn(deptData.department, deptData.employees);
        kanbanBoard.appendChild(column);
      });
      
      // 칼럼이 없으면 안내 메시지 표시
      if (departmentCount === 0) {
        kanbanBoard.innerHTML = `
          <div class="board-loading">
            <p>표시할 부서가 없습니다. 부서를 먼저 생성해주세요.</p>
          </div>
        `;
      }
    }
    
    /**
     * 🏢 부서 보드 칼럼 생성
     */
    function createDepartmentBoardColumn(department, employees) {
      const column = document.createElement('div');
      column.className = 'department-column';
      column.setAttribute('data-dept-id', department.deptId);
      
      // 칼럼 헤더
      const header = document.createElement('div');
      header.className = 'column-header';
      header.innerHTML = `
        <h3 class="column-title">
          🏢 ${department.deptName}
          <span class="column-count">${employees.length}</span>
        </h3>
      `;
      
      // 칼럼 바디
      const body = document.createElement('div');
      body.className = 'column-body';
      
      if (employees.length === 0) {
        // 직원이 없는 경우
        body.innerHTML = `
          <div class="column-empty">
            👥 소속 직원이 없습니다<br>
            <small>다른 부서에서 직원을 드래그해보세요</small>
          </div>
        `;
      } else {
        // 직원 카드들 생성
        employees.forEach(employee => {
          const card = createDepartmentEmployeeCard(employee);
          body.appendChild(card);
        });
      }
      
      column.appendChild(header);
      column.appendChild(body);
      
      // 🎯 드롭 이벤트 리스너 추가
      setupDepartmentColumnDropEvents(column, department);
      
      return column;
    }
    
    /**
     * 👤 부서 보드용 직원 카드 생성
     */
    function createDepartmentEmployeeCard(employee) {
      const card = document.createElement('div');
      card.className = 'employee-card';
      card.draggable = true;
      card.setAttribute('data-emp-id', employee.empId);
      
      card.innerHTML = `
        <div class="card-header">
          <div class="card-name">${employee.name}</div>
          <div class="card-empid">${employee.empId}</div>
        </div>
        <div class="card-info">
          <div class="card-email">${employee.email}</div>
          <div class="card-position">${employee.position || '직급 미지정'}</div>
        </div>
        <div class="card-actions">
          <button class="card-btn card-btn-edit" onclick="editEmployee('${employee.empId}')">
            ✏️ 수정
          </button>
          <button class="card-btn card-btn-delete" onclick="deleteEmployee('${employee.empId}')">
            🗑️ 삭제
          </button>
        </div>
      `;
      
      // 🎯 드래그 이벤트 리스너 추가
      setupDepartmentCardDragEvents(card, employee);
      
      return card;
    }
    
    /**
     * 🔄 부서 보드 새로고침
     */
    async function refreshDepartmentBoard() {
      try {
        console.log('🔄 부서 보드 새로고침 중...');
        await loadDepartmentBoard();
        console.log('✅ 부서 보드 새로고침 완료');
      } catch (error) {
        console.error('❌ 부서 보드 새로고침 오류:', error);
        showNotification('보드 새로고침 중 오류가 발생했습니다.', 'error');
      }
    }
 
    /**
     * 🏢 부서 목록 표시 (개선된 버전)
     */
    function displayDepartmentList(departments) {
      const tableBody = document.getElementById('departmentListTable');
      
      if (!departments || departments.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="empty-message">🏢 등록된 부서가 없습니다.</td></tr>';
        return;
      }
      
      tableBody.innerHTML = departments.map(dept => `
        <tr>
          <td>${dept.deptId}</td>
          <td>${dept.deptName}</td>
          <td>
            <span style="color: ${dept.employeeCount > 0 ? '#28a745' : '#6c757d'}; font-weight: 600;">
              ${dept.employeeCount || 0}명
            </span>
          </td>
          <td>
            <button class="btn btn-secondary" onclick="editDepartment('${dept.deptId}')" style="margin-right: 0.5rem;">
              <span>✏️</span> 수정
            </button>
            <button class="btn btn-danger" onclick="deleteDepartment('${dept.deptId}', '${dept.deptName}', ${dept.employeeCount || 0})">
              <span>🗑️</span> 삭제
            </button>
          </td>
        </tr>
      `).join('');
    }

    /**
     * 🏢 부서 추가
     */
    async function addDepartment(event) {
      event.preventDefault();
      
      const formData = {
        deptId: document.getElementById('deptId').value,
        deptName: document.getElementById('deptName').value
      };
      
      try {
        showLoading(true);
        const result = await callServerFunction('addDepartment', formData);
        
        if (result.success) {
          showNotification('부서가 성공적으로 추가되었습니다.', 'success');
          document.getElementById('addDepartmentForm').reset();
          loadDepartmentManagement(); // 목록 새로고침
        } else {
          showNotification('부서 추가 실패: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('부서 추가 오류:', error);
        showNotification('부서 추가 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * ⚙️ 시스템 설정 페이지 로드
     */
    async function loadSystemSettings() {
      try {
        const settings = await callServerFunction('getSystemSettings');
        
        // 설정값들을 폼에 적용
        if (settings) {
          document.getElementById('basicLeaves').value = settings.basicLeaves || 15;
          document.getElementById('maxLeaves').value = settings.maxLeaves || 25;
          document.getElementById('sessionTimeout').value = settings.sessionTimeout || 120;
          document.getElementById('leavePolicy').value = settings.leavePolicy || '입사일 기준';
        }
      } catch (error) {
        console.error('시스템 설정 로드 오류:', error);
        showNotification('시스템 설정을 불러올 수 없습니다.', 'error');
      }
    }

    /**
     * ⚙️ 시스템 설정 업데이트
     */
    async function updateSystemSettings(event) {
      event.preventDefault();
      
      const settings = {
        basicLeaves: document.getElementById('basicLeaves').value,
        maxLeaves: document.getElementById('maxLeaves').value,
        sessionTimeout: document.getElementById('sessionTimeout').value,
        leavePolicy: document.getElementById('leavePolicy').value
      };
      
      try {
        showLoading(true);
        const result = await callServerFunction('updateSystemSettings', settings);
        
        if (result.success) {
          showNotification('시스템 설정이 성공적으로 저장되었습니다.', 'success');
        } else {
          showNotification('설정 저장 실패: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('시스템 설정 저장 오류:', error);
        showNotification('설정 저장 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * 📈 개선된 통계 페이지 로드
     */
    async function loadStatistics() {
      try {
        console.log('📊 통계 데이터 로드 시작...');
        
        // 병렬로 데이터 로드
        const [stats, departmentStats] = await Promise.all([
          callServerFunction('getAdvancedStatistics'),
          callServerFunction('getDepartmentStatistics')
        ]);
        
        console.log('📊 받은 통계 데이터:', stats);
        console.log('🏢 받은 부서별 통계:', departmentStats);
        
        // 실시간 운영 지표 업데이트
        if (stats) {
          updateElement('statsPendingRequests', stats.pendingRequests + '건');
          updateElement('statsThisMonthRequests', stats.thisMonthRequests + '건');
          updateElement('statsAvgProcessTime', stats.avgProcessTime + '일');
          updateElement('statsApprovalRate', stats.approvalRate + '%');
          
          // 핵심 성과 지표 업데이트
          updateElement('statsEmployeeCount', stats.totalEmployees + '명');
          updateElement('statsAvgLeaveUsage', stats.avgLeaveUsage + '일');
          updateElement('statsDepartmentCount', stats.totalDepartments + '개');
          updateElement('statsSystemHealth', getSystemHealthText(stats.systemHealth));
        }
        
        // 부서별 현황 테이블 업데이트
        if (departmentStats) {
          updateDepartmentStatsTable(departmentStats);
        }
        
        console.log('✅ 통계 데이터 로드 완료');
        
      } catch (error) {
        console.error('❌ 통계 데이터 로드 오류:', error);
        showNotification('통계 데이터를 불러올 수 없습니다. 새로고침을 시도해보세요.', 'error');
        
        // 기본값 설정
        setDefaultStatValues();
      }
    }
    
    /**
     * 📊 요소 업데이트 헬퍼 함수
     */
    function updateElement(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value || '-';
      }
    }
    
    /**
     * 🎯 시스템 건전성 텍스트 변환
     */
    function getSystemHealthText(healthScore) {
      if (healthScore >= 90) return '우수';
      if (healthScore >= 80) return '양호';
      if (healthScore >= 70) return '보통';
      if (healthScore >= 60) return '주의';
      return '위험';
    }
    
    /**
     * 📋 부서별 통계 테이블 업데이트
     */
    function updateDepartmentStatsTable(departmentStats) {
      const tableBody = document.getElementById('departmentStatsTable');
      
      if (!departmentStats || departmentStats.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="empty-message">🏢 부서별 데이터가 없습니다.</td></tr>';
        return;
      }
      
      tableBody.innerHTML = departmentStats.map(dept => {
        const statusClass = getUsageStatusClass(dept.usageRate);
        const statusText = getUsageStatusText(dept.usageRate);
        
        return `
          <tr>
            <td style="font-weight: 500;">${dept.deptName}</td>
            <td style="text-align: center;">${dept.employeeCount}명</td>
            <td style="text-align: center;">${dept.usageRate}%</td>
            <td style="text-align: center;">${dept.avgRemainingLeaves}일</td>
            <td style="text-align: center;">
              <span class="${statusClass}">${statusText}</span>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    /**
     * 📊 사용률에 따른 상태 클래스
     */
    function getUsageStatusClass(usageRate) {
      if (usageRate >= 80) return 'status-excellent';
      if (usageRate >= 60) return 'status-good';
      if (usageRate >= 40) return 'status-warning';
      return 'status-danger';
    }
    
    /**
     * 📊 사용률에 따른 상태 텍스트
     */
    function getUsageStatusText(usageRate) {
      if (usageRate >= 80) return '활발';
      if (usageRate >= 60) return '적절';
      if (usageRate >= 40) return '저조';
      return '미흡';
    }
    
    /**
     * ⚠️ 기본값 설정
     */
    function setDefaultStatValues() {
      // 실시간 운영 지표
      updateElement('statsPendingRequests', '0건');
      updateElement('statsThisMonthRequests', '0건');
      updateElement('statsAvgProcessTime', '0일');
      updateElement('statsApprovalRate', '0%');
      
      // 핵심 성과 지표
      updateElement('statsEmployeeCount', '0명');
      updateElement('statsAvgLeaveUsage', '0일');
      updateElement('statsDepartmentCount', '0개');
      updateElement('statsSystemHealth', '데이터 없음');
    }

    /**
     * 📥 데이터 내보내기
     */
    async function exportData() {
      try {
        showLoading(true);
        const result = await callServerFunction('exportSystemData');
        
        if (result.success) {
          showNotification('데이터 내보내기가 완료되었습니다.', 'success');
          // 다운로드 링크 제공 등의 추가 처리
        } else {
          showNotification('데이터 내보내기 실패: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('데이터 내보내기 오류:', error);
        showNotification('데이터 내보내기 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * 💾 백업 생성
     */
    async function backupData() {
      try {
        showLoading(true);
        const result = await callServerFunction('createSystemBackup');
        
        if (result.success) {
          showNotification('시스템 백업이 성공적으로 생성되었습니다.', 'success');
        } else {
          showNotification('백업 생성 실패: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('백업 생성 오류:', error);
        showNotification('백업 생성 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * ✏️ 직원 수정 모달 열기
     */
    async function editEmployee(empId) {
      try {
        console.log('📝 직원 수정 모달 열기:', empId);
        
        // 해당 직원 정보 찾기
        const employee = allEmployees.find(emp => emp.empId === empId);
        if (!employee) {
          showNotification('직원 정보를 찾을 수 없습니다.', 'error');
          return;
        }
        
        // 모달 필드에 기존 데이터 채우기
        document.getElementById('editEmpId').value = employee.empId;
        document.getElementById('editEmpName').value = employee.name;
        document.getElementById('editEmpEmail').value = employee.email;
        document.getElementById('editEmpPhone').value = employee.phone || '';
        document.getElementById('editEmpDept').value = employee.deptId || '';
        document.getElementById('editEmpPosition').value = employee.position || '';
        document.getElementById('resetPasswordCheckbox').checked = false;
        
        // 부서 선택 옵션 업데이트
        await loadDepartmentOptionsForEdit();
        
        // 모달 열기
        const modal = document.getElementById('editEmployeeModal');
        modal.style.display = 'flex';
        
        // 메시지 초기화
        const messageDiv = document.getElementById('editEmployeeMessage');
        messageDiv.style.display = 'none';
        
        console.log('✅ 직원 수정 모달 열기 완료');
      } catch (error) {
        console.error('❌ 직원 수정 모달 열기 오류:', error);
        showNotification('직원 수정 모달을 열 수 없습니다.', 'error');
      }
    }

    /**
     * 🏢 수정 모달용 부서 옵션 로드
     */
    async function loadDepartmentOptionsForEdit() {
      try {
        const departments = await callServerFunction('getAllDepartments');
        const selectElement = document.getElementById('editEmpDept');
        
        selectElement.innerHTML = '<option value="">선택하세요</option>';
        departments.forEach(dept => {
          selectElement.innerHTML += `<option value="${dept.deptId}">${dept.deptName}</option>`;
        });
      } catch (error) {
        console.error('부서 옵션 로드 오류:', error);
      }
    }

    /**
     * 💾 직원 정보 변경사항 저장
     */
    async function saveEmployeeChanges() {
      try {
        const empId = document.getElementById('editEmpId').value;
        const name = document.getElementById('editEmpName').value.trim();
        const email = document.getElementById('editEmpEmail').value.trim();
        const phone = document.getElementById('editEmpPhone').value.trim();
        const deptId = document.getElementById('editEmpDept').value;
        const position = document.getElementById('editEmpPosition').value.trim();
        const resetPassword = document.getElementById('resetPasswordCheckbox').checked;
        
        // 필수 필드 검증
        if (!name || !email || !deptId) {
          showEditEmployeeMessage('이름, 이메일, 부서는 필수 입력 항목입니다.', 'error');
          return;
        }
        
        // 이메일 형식 검증
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showEditEmployeeMessage('올바른 이메일 형식을 입력해주세요.', 'error');
          return;
        }
        
        // 저장 버튼 비활성화
        const saveBtn = document.querySelector('.btn-modal-primary');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span>💾</span> 저장 중...';
        
        // 서버에 변경사항 전송
        const updateData = {
          empId: empId,
          name: name,
          email: email,
          phone: phone,
          deptId: deptId,
          position: position,
          resetPassword: resetPassword
        };
        
        const result = await callServerFunction('updateEmployee', updateData);
        
        if (result.success) {
          showEditEmployeeMessage('직원 정보가 성공적으로 수정되었습니다!', 'success');
          
          // 성공 메시지 표시 후 모달 닫기
          setTimeout(() => {
            closeEditEmployeeModal();
            showNotification('직원 정보 수정 완료', 'success');
            
            // 직원 목록 새로고침
            refreshEmployeeList();
          }, 1500);
          
        } else {
          showEditEmployeeMessage('직원 정보 수정 실패: ' + result.error, 'error');
        }
        
      } catch (error) {
        console.error('❌ 직원 정보 저장 오류:', error);
        showEditEmployeeMessage('직원 정보 저장 중 오류가 발생했습니다.', 'error');
      } finally {
        // 저장 버튼 활성화
        const saveBtn = document.querySelector('.btn-modal-primary');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<span>💾</span> 저장';
      }
    }

    /**
     * 🚫 직원 수정 모달 닫기
     */
    function closeEditEmployeeModal() {
      const modal = document.getElementById('editEmployeeModal');
      modal.style.display = 'none';
      
      // 폼 초기화
      document.getElementById('editEmployeeForm').reset();
      
      // 메시지 초기화
      const messageDiv = document.getElementById('editEmployeeMessage');
      messageDiv.style.display = 'none';
    }

    /**
     * 📧 수정 모달 내 메시지 표시
     */
    function showEditEmployeeMessage(message, type) {
      const messageDiv = document.getElementById('editEmployeeMessage');
      messageDiv.textContent = message;
      messageDiv.className = 'alert';
      
      if (type === 'success') {
        messageDiv.classList.add('alert-success');
      } else if (type === 'error') {
        messageDiv.classList.add('alert-error');
      }
      
      messageDiv.style.display = 'block';
      
      // 자동 숨김 (성공 메시지가 아닌 경우)
      if (type !== 'success') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
    }

    /**
     * 🗑️ 직원 삭제 (2단계 확인)
     */
    async function deleteEmployee(empId) {
      try {
        // 해당 직원 정보 찾기
        const employee = allEmployees.find(emp => emp.empId === empId);
        if (!employee) {
          showNotification('직원 정보를 찾을 수 없습니다.', 'error');
          return;
        }
        
        // 1단계 확인
        const firstConfirm = confirm(
          `⚠️ 직원 삭제 확인\n\n` +
          `사번: ${employee.empId}\n` +
          `이름: ${employee.name}\n` +
          `이메일: ${employee.email}\n\n` +
          `정말로 이 직원을 삭제하시겠습니까?`
        );
        
        if (!firstConfirm) {
          return;
        }
        
        // 2단계 확인 (안전장치)
        const secondConfirm = confirm(
          `🚨 최종 확인\n\n` +
          `"${employee.name}" 직원을 삭제하면 복구할 수 없습니다.\n` +
          `정말로 삭제하시겠습니까?\n\n` +
          `삭제하려면 "확인"을 클릭하세요.`
        );
        
        if (!secondConfirm) {
          return;
        }
        
        // 로딩 표시
        showLoading(true);
        
        // 서버에 삭제 요청
        const result = await callServerFunction('deleteEmployee', empId);
        
        if (result.success) {
          showNotification(`${employee.name} 직원이 성공적으로 삭제되었습니다.`, 'success');
          
          // 직원 목록 새로고침
          await refreshEmployeeList();
          
          // 검색창 초기화
          clearEmployeeSearch();
          
        } else {
          showNotification('직원 삭제 실패: ' + result.error, 'error');
        }
        
      } catch (error) {
        console.error('❌ 직원 삭제 오류:', error);
        showNotification('직원 삭제 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * ✏️ 부서 수정 모달 열기
     */
    async function editDepartment(deptId) {
      try {
        console.log('🏢 부서 수정 모달 열기:', deptId);
        
        // 해당 부서 정보 가져오기
        const department = await callServerFunction('getDepartmentById', deptId);
        if (!department) {
          showNotification('부서 정보를 찾을 수 없습니다.', 'error');
          return;
        }
        
        // 모달 필드에 기존 데이터 채우기
        document.getElementById('editDeptId').value = department.deptId;
        document.getElementById('editDeptName').value = department.deptName;
        
        // 모달 열기
        const modal = document.getElementById('editDepartmentModal');
        modal.style.display = 'flex';
        
        // 메시지 초기화
        const messageDiv = document.getElementById('editDepartmentMessage');
        messageDiv.style.display = 'none';
        
        console.log('✅ 부서 수정 모달 열기 완료');
      } catch (error) {
        console.error('❌ 부서 수정 모달 열기 오류:', error);
        showNotification('부서 수정 모달을 열 수 없습니다.', 'error');
      }
    }

    /**
     * 🚫 부서 수정 모달 닫기 (관리자 전용)
     */
    function closeEditDepartmentModal() {
      // 일반 직원에게는 불필요한 기능이므로 빈 함수로 처리
      console.log('부서 수정 모달 닫기 (관리자 전용 기능)');
    }

    /**
     * 💾 부서 정보 변경사항 저장 (관리자 전용)
     */
    async function saveDepartmentChanges() {
      // 일반 직원에게는 불필요한 기능이므로 빈 함수로 처리
      console.log('부서 정보 저장 (관리자 전용 기능)');
    }

    /**
     * 📧 부서 수정 모달 내 메시지 표시 (관리자 전용)
     */
    function showEditDepartmentMessage(message, type) {
      // 일반 직원에게는 불필요한 기능이므로 빈 함수로 처리
      console.log('부서 수정 메시지 (관리자 전용 기능):', message, type);
    }

    /**
     * 🗑️ 부서 삭제 (스마트 안전장치)
     */
    async function deleteDepartment(deptId, deptName, employeeCount) {
      try {
        console.log('🗑️ 부서 삭제 요청:', deptId, deptName, employeeCount);
        
        // 소속 직원이 있는지 확인
        if (employeeCount > 0) {
          alert(
            `⚠️ 부서 삭제 불가\n\n` +
            `부서명: ${deptName}\n` +
            `소속 직원: ${employeeCount}명\n\n` +
            `소속 직원이 있는 부서는 삭제할 수 없습니다.\n` +
            `먼저 소속 직원들을 다른 부서로 이동시킨 후 삭제해주세요.`
          );
          return;
        }
        
        // 1단계 확인
        const firstConfirm = confirm(
          `⚠️ 부서 삭제 확인\n\n` +
          `부서코드: ${deptId}\n` +
          `부서명: ${deptName}\n` +
          `소속 직원: ${employeeCount}명\n\n` +
          `정말로 이 부서를 삭제하시겠습니까?`
        );
        
        if (!firstConfirm) {
          return;
        }
        
        // 2단계 확인 (안전장치)
        const secondConfirm = confirm(
          `🚨 최종 확인\n\n` +
          `"${deptName}" 부서를 삭제하면 복구할 수 없습니다.\n` +
          `부서 관련 모든 이력이 함께 삭제됩니다.\n\n` +
          `정말로 삭제하시겠습니까?\n\n` +
          `삭제하려면 "확인"을 클릭하세요.`
        );
        
        if (!secondConfirm) {
          return;
        }
        
        // 로딩 표시
        showLoading(true);
        
        // 서버에 삭제 요청
        const result = await callServerFunction('deleteDepartment', deptId);
        
        if (result.success) {
          showNotification(`${deptName} 부서가 성공적으로 삭제되었습니다.`, 'success');
          
          // 부서 목록 새로고침
          loadDepartmentManagement();
          
        } else {
          showNotification('부서 삭제 실패: ' + result.error, 'error');
        }
        
      } catch (error) {
        console.error('❌ 부서 삭제 오류:', error);
        showNotification('부서 삭제 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    /**
     * 🎯 모달 이벤트 리스너 설정
     */
    document.addEventListener('DOMContentLoaded', function() {
      // 직원 수정 모달 배경 클릭 시 닫기
      const editEmployeeModal = document.getElementById('editEmployeeModal');
      if (editEmployeeModal) {
        editEmployeeModal.addEventListener('click', function(event) {
          // 모달 배경(overlay)을 클릭했을 때만 닫기 (모달 내용 클릭 시에는 닫지 않음)
          if (event.target === editEmployeeModal) {
            closeEditEmployeeModal();
          }
        });
      }
      
      // 부서 수정 모달 배경 클릭 시 닫기
      const editDepartmentModal = document.getElementById('editDepartmentModal');
      if (editDepartmentModal) {
        editDepartmentModal.addEventListener('click', function(event) {
          // 모달 배경(overlay)을 클릭했을 때만 닫기 (모달 내용 클릭 시에는 닫지 않음)
          if (event.target === editDepartmentModal) {
            closeEditDepartmentModal();
          }
        });
      }
      
      // ESC 키로 모달 닫기
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          // 직원 수정 모달 닫기
          const empModal = document.getElementById('editEmployeeModal');
          if (empModal && empModal.style.display === 'flex') {
            closeEditEmployeeModal();
            return;
          }
          
          // 부서 수정 모달 닫기
          const deptModal = document.getElementById('editDepartmentModal');
          if (deptModal && deptModal.style.display === 'flex') {
            closeEditDepartmentModal();
            return;
          }
        }
      });
    });
    
    // ===========================================
    // 🎯 부서 관리 드래그 앤 드롭 이벤트 처리 함수들
    // ===========================================
    
    // 드래그 중인 직원 정보 저장 (부서 관리용)
    let deptDraggedEmployee = null;
    let deptDraggedCard = null;
    
    /**
     * 👤 부서 보드용 직원 카드 드래그 이벤트 설정
     */
    function setupDepartmentCardDragEvents(card, employee) {
      // 드래그 시작
      card.addEventListener('dragstart', function(e) {
        console.log('🎯 부서 보드 드래그 시작:', employee.name);
        
        deptDraggedEmployee = employee;
        deptDraggedCard = card;
        
        // 드래그 중인 카드 스타일 적용
        card.classList.add('dragging');
        
        // 드래그 데이터 설정
        e.dataTransfer.setData('text/plain', employee.empId);
        e.dataTransfer.effectAllowed = 'move';
        
        // 모든 칼럼에 드롭 가능 상태 표시
        document.querySelectorAll('#deptKanbanBoard .department-column').forEach(column => {
          column.classList.add('drop-available');
        });
      });
      
      // 드래그 종료
      card.addEventListener('dragend', function(e) {
        console.log('🏁 부서 보드 드래그 종료');
        
        // 드래그 스타일 제거
        card.classList.remove('dragging');
        
        // 모든 칼럼의 드롭 상태 제거
        document.querySelectorAll('#deptKanbanBoard .department-column').forEach(column => {
          column.classList.remove('drop-available', 'drag-over');
        });
        
        // 드래그 상태 초기화
        deptDraggedEmployee = null;
        deptDraggedCard = null;
      });
    }
    
    /**
     * 🏢 부서 보드용 칼럼 드롭 이벤트 설정
     */
    function setupDepartmentColumnDropEvents(column, department) {
      // 드래그 오버 (드롭 존 위에 있을 때)
      column.addEventListener('dragover', function(e) {
        e.preventDefault(); // 드롭 허용
        e.dataTransfer.dropEffect = 'move';
        
        // 같은 부서인지 확인
        if (deptDraggedEmployee && deptDraggedEmployee.deptId !== department.deptId) {
          column.classList.add('drag-over');
        }
      });
      
      // 드래그 엔터 (드롭 존에 들어갈 때)
      column.addEventListener('dragenter', function(e) {
        e.preventDefault();
        
        if (deptDraggedEmployee && deptDraggedEmployee.deptId !== department.deptId) {
          column.classList.add('drag-over');
        }
      });
      
      // 드래그 리브 (드롭 존을 벗어날 때)
      column.addEventListener('dragleave', function(e) {
        // 칼럼 내부 요소로 이동하는 경우는 제외
        if (!column.contains(e.relatedTarget)) {
          column.classList.remove('drag-over');
        }
      });
      
      // 드롭 (실제 드롭 시)
      column.addEventListener('drop', function(e) {
        e.preventDefault();
        
        console.log('🎯 부서 보드 드롭 이벤트:', department.deptName);
        
        // 같은 부서로 드롭하는 경우 무시
        if (!deptDraggedEmployee || deptDraggedEmployee.deptId === department.deptId) {
          console.log('⚠️ 같은 부서로 이동 - 무시');
          return;
        }
        
        // 부서 이동 확인 및 처리
        handleDepartmentEmployeeMove(deptDraggedEmployee, department);
        
        // 드래그 오버 스타일 제거
        column.classList.remove('drag-over');
      });
    }
    
    /**
     * 🔄 부서 보드에서 직원 부서 이동 처리
     */
    async function handleDepartmentEmployeeMove(employee, targetDepartment) {
      try {
        console.log('🔄 부서 보드 부서 이동 처리:', employee.name, '->', targetDepartment.deptName);
        
        // 확인 다이얼로그
        const confirmed = confirm(
          `👤 직원 부서 이동 확인\n\n` +
          `직원: ${employee.name} (${employee.empId})\n` +
          `현재 부서: ${employee.deptName || '미지정'}\n` +
          `이동할 부서: ${targetDepartment.deptName}\n\n` +
          `정말로 부서를 이동하시겠습니까?`
        );
        
        if (!confirmed) {
          console.log('🚫 부서 이동 취소됨');
          return;
        }
        
        // 로딩 표시
        showLoading(true);
        
        // 서버에 부서 이동 요청
        const result = await callServerFunction('moveEmployeeDepartment', {
          empId: employee.empId,
          newDeptId: targetDepartment.deptId
        });
        
        if (result.success) {
          showNotification(
            `${employee.name}님이 ${targetDepartment.deptName}으로 이동되었습니다.`, 
            'success'
          );
          
          // 부서 보드 새로고침
          await refreshDepartmentBoard();
          
          // 부서 목록도 새로고침 (소속 직원 수 업데이트)
          await loadDepartmentManagement();
          
          // 직원 목록도 새로고침 (동기화)
          if (typeof refreshEmployeeList === 'function') {
            await refreshEmployeeList();
          }
          
        } else {
          showNotification('부서 이동 실패: ' + result.error, 'error');
        }
        
      } catch (error) {
        console.error('❌ 부서 이동 오류:', error);
        showNotification('부서 이동 중 오류가 발생했습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }
    
    // 부서 관리 페이지 로드 시 보드 초기화 연동
    const originalLoadDepartmentManagement = loadDepartmentManagement;
    loadDepartmentManagement = async function() {
      await originalLoadDepartmentManagement();
      
      // 보드 뷰가 활성화된 경우 보드 데이터도 로드
      const boardView = document.getElementById('departmentBoardView');
      if (boardView && boardView.classList.contains('active')) {
        await loadDepartmentBoard();
      }
    };

    // 직원 필터링 함수
    function filterEmployees(searchTerm) {
      const employeeList = document.getElementById('employeeList');
      const items = employeeList.getElementsByClassName('employee-item');
      
      searchTerm = searchTerm.toLowerCase();
      
      for (const item of items) {
        const name = item.querySelector('.employee-name').textContent.toLowerCase();
        const dept = item.querySelector('.employee-dept').textContent.toLowerCase();
        const position = item.querySelector('.employee-position').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || dept.includes(searchTerm) || position.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      }
    }

    // 결재자 선택 관련 함수들
    function toggleLeaveApprover(empData) {
      const emp = typeof empData === 'string' ? JSON.parse(empData) : empData;
      const index = selectedApprovers.findIndex(a => a.empId === emp.empId);
      
      if (index === -1) {
        selectedApprovers.push(emp);
      } else {
        selectedApprovers.splice(index, 1);
      }
      
      // 선택 상태 UI 업데이트
      const employeeItem = document.querySelector(`.employee-item[data-employee='${JSON.stringify(emp)}']`);
      if (employeeItem) {
        employeeItem.classList.toggle('selected');
      }
    }

    function closeApproverModal() {
      const modal = document.getElementById('approverModal');
      if (modal) {
        modal.remove();
      }
    }

    function confirmApprovers() {
      if (selectedApprovers.length === 0) {
        showNotification('결재자를 한 명 이상 선택해주세요.', 'error');
        return;
      }
      
      // 선택된 결재자 목록 업데이트
      updateSelectedApprovers();
      
      // 모달 닫기
      closeApproverModal();
    }

    /**
     * 🤝 협조자 선택 모달 열기
     */
    async function openCollaboratorModal() {
      try {
        // 로딩 표시 시작
        showLoading(true);

        // 직원 목록 로드
        const employees = await callServerFunction('getEmployeesForWeb');
        if (!employees || !Array.isArray(employees)) {
          throw new Error('직원 목록을 불러올 수 없습니다.');
        }

        // 현재 사용자 ID
        const currentUserId = document.getElementById('userEmpId')?.textContent;
        if (!currentUserId) {
          throw new Error('사용자 정보를 찾을 수 없습니다.');
        }

        // 모달 생성 및 스타일 적용
        const modalHtml = `
          <div class="modal-overlay" id="collaboratorModal">
            <div class="modal-container" style="width: 80%; max-width: 800px; max-height: 80vh; margin: 10vh auto;">
              <div class="modal-header">
                <h3>협조자 선택</h3>
                <button class="close-button" onclick="closeCollaboratorModal()">×</button>
              </div>
              <div class="modal-body" style="max-height: calc(80vh - 180px); overflow-y: auto;">
                <div class="search-box">
                  <input type="text" id="employeeSearchInput" placeholder="이름 또는 부서로 검색..." 
                         onkeyup="filterEmployees(this.value)">
                </div>
                <div id="employeeList" class="employee-list">
                  ${employees
                    .filter(emp => emp && emp.empId && emp.empId !== currentUserId)
                    .map(emp => `
                      <div class="employee-item ${selectedCollaborators.some(c => c.empId === emp.empId) ? 'selected' : ''}"
                           data-employee='${JSON.stringify(emp)}'
                           onclick="toggleLeaveCollaborator(this.dataset.employee)">
                        <div class="employee-info">
                          <div class="employee-name">${emp.name || '이름 없음'}</div>
                          <div class="employee-position">${emp.position || '직급 미지정'}</div>
                        </div>
                        <div class="employee-dept">${emp.deptName || '부서 미지정'}</div>
                      </div>
                    `).join('')}
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeCollaboratorModal()">취소</button>
                <button class="btn-modal btn-modal-primary" onclick="confirmCollaborators()">확인</button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달이 있다면 제거
        const existingModal = document.getElementById('collaboratorModal');
        if (existingModal) {
          existingModal.remove();
        }

        // 새 모달 추가
        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (error) {
        console.error('협조자 모달 오류:', error);
        showNotification('협조자 선택 모달을 열 수 없습니다.', 'error');
      } finally {
        showLoading(false);
      }
    }

    /**
     * ✅ 협조자 토글 선택
     */
    function toggleLeaveCollaborator(empData) {
      const emp = typeof empData === 'string' ? JSON.parse(empData) : empData;
      const index = selectedCollaborators.findIndex(c => c.empId === emp.empId);
      
      if (index === -1) {
        selectedCollaborators.push(emp);
      } else {
        selectedCollaborators.splice(index, 1);
      }
      
      // 선택 상태 UI 업데이트
      const employeeItem = document.querySelector(`.employee-item[data-employee='${JSON.stringify(emp)}']`);
      if (employeeItem) {
        employeeItem.classList.toggle('selected');
      }
    }

    /**
     * ❌ 협조자 선택 모달 닫기
     */
    function closeCollaboratorModal() {
      const modal = document.getElementById('collaboratorModal');
      if (modal) {
        modal.remove();
      }
    }

    /**
     * ✅ 협조자 선택 완료
     */
    function confirmCollaborators() {
      updateSelectedCollaborators();
      closeCollaboratorModal();
    }

    /**
     * 🔧 시스템 진단 도구
     */
    async function runSystemDiagnostics() {
      const diagnostics = {
        timestamp: new Date().toISOString(),
        currentUser: currentUser,
        googleScriptAvailable: typeof google !== 'undefined' && !!google.script,
        userAgent: navigator.userAgent,
        url: window.location.href,
        checks: []
      };

      // 1. 사용자 정보 확인
      const userCheck = {
        test: '사용자 정보 로드',
        passed: false,
        message: '',
        details: null
      };

      try {
        if (currentUser && currentUser.empId && currentUser.empId !== 'UNKNOWN' && currentUser.empId !== 'ERROR') {
          userCheck.passed = true;
          userCheck.message = '사용자 정보 정상';
          userCheck.details = currentUser;
        } else {
          userCheck.message = '사용자 정보 오류: ' + JSON.stringify(currentUser);
        }
      } catch (error) {
        userCheck.message = '사용자 정보 확인 실패: ' + error.message;
      }
      diagnostics.checks.push(userCheck);

      // 2. Google Apps Script 환경 확인
      const gasCheck = {
        test: 'Google Apps Script 환경',
        passed: false,
        message: '',
        details: null
      };

      try {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          gasCheck.passed = true;
          gasCheck.message = 'Google Apps Script 환경 정상';
          gasCheck.details = {
            googleDefined: typeof google !== 'undefined',
            scriptDefined: !!google.script,
            runDefined: !!google.script.run
          };
        } else {
          gasCheck.message = 'Google Apps Script 환경 오류';
          gasCheck.details = {
            googleDefined: typeof google !== 'undefined',
            scriptDefined: typeof google !== 'undefined' && !!google.script,
            runDefined: typeof google !== 'undefined' && !!google.script && !!google.script.run
          };
        }
      } catch (error) {
        gasCheck.message = 'Google Apps Script 환경 확인 실패: ' + error.message;
      }
      diagnostics.checks.push(gasCheck);

      // 3. 서버 함수 테스트
      const serverCheck = {
        test: '서버 함수 호출',
        passed: false,
        message: '',
        details: null
      };

      try {
        const testResult = await callServerFunction('getMyRequests', currentUser.empId);
        serverCheck.passed = true;
        serverCheck.message = '서버 함수 호출 성공';
        serverCheck.details = {
          resultType: typeof testResult,
          isArray: Array.isArray(testResult),
          length: testResult ? testResult.length : 0
        };
      } catch (error) {
        serverCheck.message = '서버 함수 호출 실패: ' + error.message;
        serverCheck.details = { error: error.toString() };
      }
      diagnostics.checks.push(serverCheck);

      // 4. 시트 구조 확인
      const sheetCheck = {
        test: '시트 구조 확인',
        passed: false,
        message: '',
        details: null
      };

      try {
        const sheetInfo = await callServerFunction('debugLeaveRequestsSheet');
        if (sheetInfo && !sheetInfo.error) {
          sheetCheck.passed = true;
          sheetCheck.message = `시트 구조 확인 성공 - 총 ${sheetInfo.totalRows}행, ${sheetInfo.totalCols}열`;
          sheetCheck.details = sheetInfo;
        } else {
          sheetCheck.message = '시트 구조 확인 실패: ' + (sheetInfo.message || '알 수 없는 오류');
          sheetCheck.details = sheetInfo;
        }
      } catch (error) {
        sheetCheck.message = '시트 구조 확인 실패: ' + error.message;
        sheetCheck.details = { error: error.toString() };
      }
      diagnostics.checks.push(sheetCheck);

      // 결과 출력
      console.log('🔧 시스템 진단 결과:', diagnostics);
      
      // 진단 결과 표시
      const summary = diagnostics.checks.map(check => 
        `${check.passed ? '✅' : '❌'} ${check.test}: ${check.message}`
      ).join('\n');
      
      const alert_message = `시스템 진단 완료\n\n${summary}\n\n자세한 내용은 콘솔을 확인하세요.`;
      alert(alert_message);
      
      return diagnostics;
    }

    /**
     * 🔍 빠른 시트 디버깅
     */
    async function quickSheetDebug() {
      try {
        console.log('🔍 빠른 시트 디버깅 시작...');
        
        // 시트 구조 확인
        const sheetInfo = await callServerFunction('debugLeaveRequestsSheet');
        console.log('📊 시트 정보:', sheetInfo);
        
        // 내 신청 현황 다시 조회
        const myRequests = await callServerFunction('getMyRequests', currentUser.empId);
        console.log('📋 내 신청 현황:', myRequests);
        
        // 요약 정보 표시
        const summary = `
=== 🔍 빠른 시트 디버깅 결과 ===

📊 시트 기본 정보:
- 총 행 수: ${sheetInfo.totalRows}
- 총 열 수: ${sheetInfo.totalCols}
- 헤더: ${JSON.stringify(sheetInfo.header)}

📋 내 신청 현황:
- 타입: ${typeof myRequests}
- 배열 여부: ${Array.isArray(myRequests)}
- 길이: ${myRequests ? myRequests.length : 'N/A'}

📊 현재 사용자 정보:
- 직원ID: ${currentUser.empId}
- 이름: ${currentUser.name}

자세한 내용은 콘솔을 확인하세요.
        `;
        
        console.log(summary);
        alert(summary);
        
        return {
          sheetInfo,
          myRequests,
          currentUser
        };
      } catch (error) {
        console.error('❌ 빠른 시트 디버깅 오류:', error);
        alert('빠른 시트 디버깅 실패: ' + error.message);
        return null;
      }
    }

    /**
     * 🚨 코드 업데이트 확인 함수
     */
    async function checkCodeUpdate() {
      try {
        console.log('🚨 코드 업데이트 확인 시작...');
        
        const result = await new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error('코드 업데이트 확인 시간 초과'));
          }, 10000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              reject(new Error(error.toString()));
            })
            .checkCodeUpdate();
        });
        
        console.log('✅ 코드 업데이트 확인 결과:', result);
        
        const message = `
=== 🚨 코드 업데이트 확인 결과 ===

✅ ${result.message}
📅 업데이트 시간: ${result.timestamp}
🔢 버전: ${result.version}

이제 내신청 현황이 정상 작동할 것입니다!
        `;
        
        console.log(message);
        alert(message);
        
        return result;
      } catch (error) {
        console.error('❌ 코드 업데이트 확인 실패:', error);
        
        const message = `
❌ 코드 업데이트 확인 실패

오류: ${error.message}

해결 방법:
1. Google Apps Script 에디터에서 저장 (Ctrl+S)
2. 새 버전으로 재배포
3. 웹 앱 페이지 새로고침
        `;
        
        console.log(message);
        alert(message);
        
        return null;
      }
    }

    /**
     * 🧪 간단한 서버 통신 테스트
     */
    async function testServerConnection() {
      try {
        console.log('🧪 서버 통신 테스트 시작...');
        
        const result = await new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error('서버 응답 시간 초과'));
          }, 15000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              reject(new Error(error.toString()));
            })
            .testServerConnection();
        });
        
        console.log('✅ 서버 통신 테스트 성공:', result);
        alert(`✅ 서버 통신 성공!\n${result.message}\n시간: ${result.timestamp}`);
        return result;
      } catch (error) {
        console.error('❌ 서버 통신 테스트 실패:', error);
        alert(`❌ 서버 통신 실패!\n${error.message}`);
        return null;
      }
    }

    /**
     * 🧪 현재 세션 상태 확인
     */
    async function testCurrentSession() {
      try {
        console.log('🧪 세션 상태 확인 시작...');
        
        const result = await new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error('세션 확인 시간 초과'));
          }, 15000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              reject(new Error(error.toString()));
            })
            .getCurrentSessionStatus();
        });
        
        console.log('✅ 세션 상태 확인 성공:', result);
        
        if (result.success) {
          const message = `
✅ 세션 상태 확인 성공!

📋 세션 정보:
- 세션 존재: ${result.hasSession ? 'Yes' : 'No'}
- 사용자 타입: ${result.sessionType || 'N/A'}
- 직원 ID: ${result.empId || 'N/A'}
- 관리자 ID: ${result.adminId || 'N/A'}
- 확인 시간: ${result.timestamp}
          `;
          alert(message);
        } else {
          alert(`❌ 세션 상태 확인 실패!\n${result.error}`);
        }
        
        return result;
      } catch (error) {
        console.error('❌ 세션 상태 확인 실패:', error);
        alert(`❌ 세션 상태 확인 실패!\n${error.message}`);
        return null;
      }
    }

    /**
     * 🧪 LeaveRequests 시트 상태 확인
     */
    async function testLeaveRequestsSheet() {
      try {
        console.log('🧪 LeaveRequests 시트 상태 확인 시작...');
        
        const result = await new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error('시트 확인 시간 초과'));
          }, 15000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              reject(new Error(error.toString()));
            })
            .checkLeaveRequestsSheet();
        });
        
        console.log('✅ LeaveRequests 시트 상태 확인 성공:', result);
        
        if (result.success) {
          const message = `
✅ LeaveRequests 시트 상태 확인 성공!

📊 시트 정보:
- 시트 존재: ${result.sheetExists ? 'Yes' : 'No'}
- 총 행 수: ${result.totalRows}
- 헤더: ${JSON.stringify(result.headerRow)}
- 데이터 행 수: ${result.totalRows - 1}
- 확인 시간: ${result.timestamp}

📋 샘플 데이터:
${JSON.stringify(result.sampleDataRows, null, 2)}
          `;
          alert(message);
        } else {
          alert(`❌ LeaveRequests 시트 상태 확인 실패!\n${result.error}`);
        }
        
        return result;
      } catch (error) {
        console.error('❌ LeaveRequests 시트 상태 확인 실패:', error);
        alert(`❌ LeaveRequests 시트 상태 확인 실패!\n${error.message}`);
        return null;
      }
    }

    /**
     * 🧪 단계별 진단 실행
     */
    async function runStepByStepDiagnosis() {
      console.log('🚀 단계별 진단 시작...');
      
      const results = {
        step1: null,
        step2: null,
        step3: null,
        step4: null
      };
      
      // Step 1: 서버 통신 테스트
      console.log('📞 Step 1: 서버 통신 테스트');
      results.step1 = await testServerConnection();
      if (!results.step1) {
        alert('❌ Step 1 실패: 서버 통신 불가능\n웹앱이 올바르게 배포되었는지 확인하세요.');
        return results;
      }
      
      // Step 2: 세션 상태 확인
      console.log('👤 Step 2: 세션 상태 확인');
      results.step2 = await testCurrentSession();
      if (!results.step2 || !results.step2.success || !results.step2.hasSession) {
        alert('❌ Step 2 실패: 세션이 없습니다\n로그아웃 후 다시 로그인하세요.');
        return results;
      }
      
      // Step 3: 시트 상태 확인
      console.log('📊 Step 3: LeaveRequests 시트 상태 확인');
      results.step3 = await testLeaveRequestsSheet();
      if (!results.step3 || !results.step3.success) {
        alert('❌ Step 3 실패: LeaveRequests 시트 문제\n시트가 존재하고 헤더가 올바른지 확인하세요.');
        return results;
      }
      
      // Step 4: getMyRequests 함수 테스트
      console.log('🔍 Step 4: getMyRequests 함수 테스트');
      try {
        const myRequests = await new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error('getMyRequests 함수 응답 시간 초과'));
          }, 30000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              resolve(result);
            })
            .withFailureHandler((error) => {
              clearTimeout(timeoutId);
              reject(new Error(error.toString()));
            })
            .getMyRequests(currentUser.empId);
        });
        
        results.step4 = {
          success: true,
          result: myRequests,
          type: typeof myRequests,
          isArray: Array.isArray(myRequests),
          length: myRequests ? myRequests.length : 0
        };
        
        console.log('✅ Step 4 성공:', results.step4);
        
        const finalMessage = `
🎉 모든 단계 성공!

📊 getMyRequests 결과:
- 타입: ${results.step4.type}
- 배열 여부: ${results.step4.isArray}
- 데이터 개수: ${results.step4.length}

이제 "내 신청 현황"이 정상 작동할 것입니다!
        `;
        
        alert(finalMessage);
      } catch (error) {
        console.error('❌ Step 4 실패:', error);
        results.step4 = {
          success: false,
          error: error.message
        };
        
        alert(`❌ Step 4 실패: getMyRequests 함수 오류\n${error.message}\n\n앞의 3단계는 성공했으므로 함수 로직에 문제가 있을 수 있습니다.`);
      }
      
      console.log('🎯 전체 진단 결과:', results);
      return results;
    }

    // 개발자 도구에서 바로 실행할 수 있도록 전역 함수로 설정
    window.runSystemDiagnostics = runSystemDiagnostics;
    window.loadMyRequests = loadMyRequests;
    window.quickSheetDebug = quickSheetDebug;
    window.checkCodeUpdate = checkCodeUpdate;
    window.testServerConnection = testServerConnection;
    window.testCurrentSession = testCurrentSession;
    window.testLeaveRequestsSheet = testLeaveRequestsSheet;
    window.runStepByStepDiagnosis = runStepByStepDiagnosis;
  </script>
</body>
</html> 